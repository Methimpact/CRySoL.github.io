
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ZeroC Ice: Persistencia de sirvientes con Freeze Evictor</title>
    
    <meta name="author" content="CRySoL">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js"></script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    

  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-narrow">
<!--
	  <a class="brand-image" href="/"><img class="brand-image" src="/assets/themes/twitter/logo.png"/></a>
-->
          <a class="brand" href="/">CRySoL</a>
          <ul class="nav">
            
            
            


  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/recipes.html">Recipes</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/users.html">Users</a></li>
      	
      
    
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="row-fluid">
	<div class="content">
          
<div class="sidebar span3">
  <div id="logo">
  <a href="/">
    <img src="/assets/images/logo.png" alt="logo"/>
  </a>
</div>

  <div class="metadata">
  <h2>this</h2>
  <ul>
    
      <li>author: 
  <a href="/users.html#oscarah">
   oscarah
  </a>


        
        <span class="author-photo">

  
    <img src="/assets/files/pictures/picture-111.gif" width="48" alt="picture"/>
  

</span>

      </li>
      
    

    <li>created: 2008-01-23 </li>

    <li><a href="https://github.com/CRySoL/web.source/raw/master/_posts/migrated/2008-01-23-zeroc-ice-persistencia-de-sirvientes-con-freeze-evictor.textile">source / <a href="https://github.com/CRySoL/web.source/edit/master/_posts/migrated/2008-01-23-zeroc-ice-persistencia-de-sirvientes-con-freeze-evictor.textile">edit</a></li>

  
    <li>categories:
    
      <a href="/categories.html#recipe-ref">recipe</a>
    
    </li>
  

  
      <li>migrated&nbsp;from&nbsp;<a href="http://crysol.org/node/842">node/842</a></li>
  

  
    <li>tags:
    
      <a href="/tags.html#C++-ref">C++</a>
    
      <a href="/tags.html#Ice-ref">Ice</a>
    
      <a href="/tags.html#Arco-ref">Arco</a>
    
    </li>
  
  </ul>

  
     
     
  

  
     
     
  
     
     
     <a class="tag-icon" href="/tags.html#Ice-ref">
        <img src="http://crysol.org/files/category_pictures/zeroc_logo.png" title="Ice" alt="Ice-icon"/>
     </a>
     
  
     
     
     <a class="tag-icon" href="/tags.html#Arco-ref">
        <img src="http://crysol.org/files/category_pictures/arco_3D_taxonomy.png" title="Arco" alt="Arco-icon"/>
     </a>
     
  

  <!-- AddThis Button BEGIN -->
<div class="share addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Button END -->

</div>

<div class="related">
  <h2>related</h2>
  <ul>
    
    <li><a href="/recipe/2005-09-13/ssh-y-scp-para-acceder-a-equipos-remotos-sin-escribir-la-clave-public-key-authentication">SSH y SCP para acceder a equipos remotos sin escribir la clave (public key authentication)</a></li>
    
    <li><a href="/2005-09-24/acabo-de-registrarme-en-el-portal">Acabo de registrarme en el Portal</a></li>
    
    <li><a href="/2005-09-26/buenas-a-tods">Buenas a tod@s!</a></li>
    
    <li><a href="/tale/2005-09-26/instalacin-local-de-mambo-joomla-bajo-gnu-linux">Instalación local de Mambo / Joomla bajo GNU/Linux</a></li>
    
    <li><a href="/recipe/2005-09-27/acceso-a-red-cmpus-con-firefox-y-greasemonkey">Acceso a Red C@mpus con Firefox y Greasemonkey</a></li>
    
  </ul>
</div>

<div class="recent">
  <h2>recent</h2>
  <ul>
  
    <li><a href="/recipe/2013-10-05/virtualbox-import-export-clone">VirtualBox: import/export and cloning machines</a></li>
  
    <li><a href="/recipe/2013-09-23/virtualbox-vmdk-to-vdi">Converting .vmdk virtual disk to .vdi format from command line</a></li>
  
    <li><a href="/recipe/2013-09-19/ice35-deb-packages-from-zeroc">Installing the Ice-3.5 packages from ZeroC on Debian</a></li>
  
    <li><a href="/recipe/2013-09-03/DSO">Undertanding the DSO Link Change</a></li>
  
    <li><a href="/recipe/2013-08-11/hp-p1005-debian">HP LaserJet P1005 with Debian and the free driver</a></li>
  
  </ul>
</div>

</div>

<div class="node span9">
  <div class="page-header">
    <h1>ZeroC Ice: Persistencia de sirvientes con Freeze Evictor </h1>
  </div>

  <div class="row-fluid post-full">
    <div class="span12">
      <div class="content">
	<p>Cómo integrar Freeze en aplicaciones existentes para obtener persistencia en los sirvientes.</p>
<p><!--break--></p>
<h2>Ingredientes</h2>
<ul>
<li>ZeroC-Ice instalado y funcionando.</li>
<li>La aplicación que queremos que persista.</li>
</ul>
<h2>Empezando</h2>
<p>Nuestro objetivo es simple: añadir persistencia a los sirvientes de nuestras aplicaciones. Con ello, es posible restaurar el estado de un sirviente, aunque la aplicación haya terminado. Además, puesto que usamos el Evictor de Freeze, tenemos gestión de recursos: reactivación de sirvientes bajo demanda y desactivación de objetos que no se usan. De esta forma, optimizamos los recursos de la máquina.</p>
<p>El Evictor mantiene una lista de los sirvientes más recientemente usados, y que están disponibles directamente. El resto de sirvientes están guardados en una base de datos. En caso de que sea necesario acceder a alguno de ellos, el Evictor se encarga de todo: crea un nuevo objeto de ese mismo tipo y actualiza su estado con información de la base de datos, para que sirva las peticiones convenientemente.</p>
<p>Es la implementación del patrón evictor. Para más información sobre este patrón, consultad <sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup>.</p>
<h2>Ejemplo sin Freeze</h2>
<p>Supongamos que tenemos un sencillo sistema de mensajes. Consta de una aplicación que instancia tantos sirvientes como mensajes se deseen guardar. Estos sirvientes mantienen el contenido del mensaje, y aportan la interfaz para leerlo o modificarlo. La definición de dicho slice es:</p>
<p><b>Nota</b>: en <sup class="footnote" id="fnr3"><a href="#fn3">3</a></sup> está disponible el código fuente completo de estos ejemplos. Te lo puedes descargar con subversion: &#8216;svn co <sup class="footnote" id="fnr3"><a href="#fn3">3</a></sup>&#8217;</p>
<p><u>Message.ice</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>
<span class="c1">// Message service.</span>
<span class="n">module</span> <span class="n">UCLM</span> <span class="p">{</span>
  <span class="n">interface</span> <span class="n">Message</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">string</span> <span class="n">msg</span><span class="p">);</span>
    <span class="n">string</span> <span class="nf">read</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>
<p>Los sirvientes que implementan Message, sólo permiten leer y escribir el contenido del mensaje. Donde se guardan los datos es un detalle de implementación. En este caso, se almacenan en una variable llamada <i>message</i> de tipo string, pero podría ser cualquier sitio: un fichero en disco, una base de datos, /dev/null&#8230;</p>
<p>La declaración de los sirvientes podría ser como sigue:</p>
<p><u>MessageI.h</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>

<span class="cp">#ifndef __MessageI_h__</span>
<span class="cp">#define __MessageI_h__</span>

<span class="cp">#include &lt;Message.h&gt;</span>

<span class="k">namespace</span> <span class="n">UCLM</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">MessageI</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">Message</span> <span class="p">{</span>
  <span class="nl">public:</span>

    <span class="n">MessageI</span><span class="p">(</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">);</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Current</span><span class="o">&amp;</span><span class="p">);</span>

    <span class="k">virtual</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">read</span><span class="p">(</span><span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Current</span><span class="o">&amp;</span><span class="p">);</span>

  <span class="nl">private:</span>  
    <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// __MessageI_h__</span>
</code></pre></div></div>

<p>Tiene un constructor para inicializar el objeto desde el servidor. La implementación es trivial: leer <i>message</i> o escribirlo. Este ejemplo es bastante sencillo, pero podría ser una aplicación cualquiera. Para instanciar estos sirvientes, tenemos un servidor normal y corriente:</p>
<p><u>Server.cpp</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>

<span class="c1">// Messase service.</span>

<span class="cp">#include &lt;MessageI.h&gt;</span>
<span class="cp">#include &lt;Ice/Ice.h&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">UCLM</span><span class="p">;</span>

<span class="cp">#define MAX_SERVS 100000</span>

<span class="k">class</span> <span class="nc">MessageServer</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Application</span> <span class="p">{</span>
<span class="nl">public:</span>

  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">run</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

    <span class="n">_ic</span> <span class="o">=</span> <span class="n">communicator</span><span class="p">();</span>
    
    <span class="c1">// Create the object adapter</span>
    <span class="n">_adapter</span> <span class="o">=</span> <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">createObjectAdapterWithEndpoints</span><span class="p">(</span><span class="s">&quot;MServer&quot;</span><span class="p">,</span> <span class="s">&quot;tcp -h 127.0.0.1 -p 11111&quot;</span><span class="p">);</span>
    <span class="n">_adapter</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">();</span>
    
    <span class="c1">// Create MAX_SERVS servants</span>
    <span class="n">UCLM</span><span class="o">::</span><span class="n">MessagePtr</span> <span class="n">serv</span><span class="p">;</span>
    <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectPrx</span> <span class="n">prx</span><span class="p">;</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Creating posts from 0 to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_SERVS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ...&quot;</span><span class="p">;</span>
    <span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SERVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="n">ostringstream</span> <span class="n">sid</span><span class="p">;</span>
      <span class="n">sid</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Post&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">serv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UCLM</span><span class="o">::</span><span class="n">MessageI</span><span class="p">(</span><span class="s">&quot;Message from &quot;</span> <span class="o">+</span> <span class="n">sid</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
      <span class="n">prx</span> <span class="o">=</span> <span class="n">_adapter</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">stringToIdentity</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">str</span><span class="p">()));</span>
    <span class="p">}</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; done.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Proxies at &#39;PostX -t:tcp -h 127.0.0.1 -p 11111&#39; where X is post number.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Waiting events...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">shutdownOnInterrupt</span><span class="p">();</span>
    <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">waitForShutdown</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>


<span class="nl">private:</span>

  <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectAdapterPtr</span> <span class="n">_adapter</span><span class="p">;</span>
  <span class="n">Ice</span><span class="o">::</span><span class="n">CommunicatorPtr</span> <span class="n">_ic</span><span class="p">;</span>

<span class="p">};</span>
</code></pre></div></div>
<p>Este servidor no tiene nada especial: hereda de <i>Ice.Application</i>, crea un adaptador de objetos al que añade 100.000 sirvientes de tipo Message y espera eventos. El cliente simplemente accede a estos objetos usando el proxy adecuado. En principio, un uso muy común y sencillo de Ice.</p>
<p>Si ejecutamos el servidor, los 100.000 sirvientes (100.000 instancias de la clase MessageI) se quedan residentes en memoria. Generalmente, no los usaremos todos al mismo tiempo, sólo una parte de ellos, por lo que mantenerlos en memoria es caro e ineficiente. Por otro lado, si modificamos el estado de alguna de estas instancias y el servidor termina, las modificaciones se habrán perdido. Por ello, vamos a usar Freeze.</p>
<h2>Ejemplo con Freeze</h2>
<p>Por supuesto, es incómodo tener que rehacer todo nuestro software para añadir el Evictor de Freeze. Suerte que se lo han pensado bien para que no tengamos que sufrir mucho.</p>
<p>Intentaremos modificar lo menos posible. Así pues, lo primero que hacemos es un estudio de impacto en nuestras aplicaciones. Si mantenemos las interfaces, los clientes no varían en absoluto, y es perfectamente posible hacerlo.</p>
<p>Un aspecto a tener en cuenta: si sólo tenemos definidas las interfaces en el slice (es decir, no usamos clases, por lo que no tenemos atributos), Ice no sabe qué es lo que debe persistir, ya que la serialización de los datos se hace de la misma forma que si se enviaran por la red. Es decir, si queremos que un atributo sea persistente, debe estar definido en el slice, por lo que en vez de interfaces, debemos usar clases.</p>
<p>También, puesto que el Evictor debe saber cuando actualizar la base de datos y cuando no, hemos de especificar si los métodos modifican el contenido de los objetos. Esto se consigue añadiendo metainformación en el slice: [&#8220;freeze:read&#8221;] para los métodos que no modifican el estado y [&#8220;freeze:write&#8221;] para aquellos que sí lo hacen.</p>
<p>Otro requisito a tener en cuenta es la necesidad de usar factorías para la instanciación de nuestros sirvientes: un requisito de Freeze. De nuevo, tenemos ayudas en Ice para ello.</p>
<p>Veamos las modificaciones. En primer lugar, vamos a cambiar el slice original para incluir la metainformación de Freeze:</p>
<p><u>Message.ice</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>
<span class="c1">// Message service.</span>

<span class="n">module</span> <span class="n">UCLM</span> <span class="p">{</span>

  <span class="n">interface</span> <span class="n">Message</span> <span class="p">{</span>
    <span class="p">[</span><span class="s">&quot;freeze:write&quot;</span><span class="p">]</span> <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">string</span> <span class="n">msg</span><span class="p">);</span>
    <span class="n">string</span> <span class="nf">read</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>
<p>Puesto que, por defecto, Freeze considera que los métodos no modifican el estado, no es necesario especificarlo explícitamente para <i>read()</i>. Estas modificaciones no afectan en absoluto a compilaciones posteriores de la versión original del software, por lo que son inocuas.</p>
<p>Lo próximo es añadir los atributos que serán persistentes. En la implementación de nuestro ejemplo, guardamos el mensaje en una variable de tipo <i>string</i> llamada <i>message</i>. Ese será el atributo que añadiremos a una nueva clase, que implementará nuestra interfaz Message. Para mantener las cosas sencillas, aquí lo hago en un nuevo fichero (pero esto no es obligatorio):</p>
<p><u>PersistentMessage.ice</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>
<span class="c1">// Message service with persistence.</span>

<span class="cp">#include &quot;Message.ice&quot;</span>

<span class="n">module</span> <span class="n">UCLM</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">PersistentMessage</span> <span class="n">implements</span> <span class="n">Message</span> <span class="p">{</span>
    <span class="n">string</span> <span class="n">message</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>
<p>Perfecto. Ahora, el código de los sirvientes persistentes. Puesto que hemos hecho coincidir los nombres de las variables, la implementación es idéntica. Lo único que añadiremos será:</p>
<ul>
<li> Un constructor vacío (que lo usaremos en la factoría, pero que es particular para este caso, y por tanto, puede que no sea necesario en otros)</li>
<li> Un inicializador, al que llamará el Evictor una vez que haya restaurado un sirviente y antes de hacerlo disponible. Se usa en caso de que sea necesario modificar algo del sirviente (aquí no lo necesitamos)</li>
<li> Una factoría que usará el Evictor para instanciar nuestros sirvientes (esto si que es necesario).</ul>
<p>Con estos cambios, la cabecera del sirviente viene siendo:</p>
<p><u>PersistentMessageI.h</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>

<span class="cp">#ifndef __PersistentMessageI_h__</span>
<span class="cp">#define __PersistentMessageI_h__</span>

<span class="cp">#include &lt;Freeze/Freeze.h&gt;</span>
<span class="cp">#include &lt;IceUtil/IceUtil.h&gt;</span>

<span class="cp">#include &lt;PersistentMessage.h&gt;</span>

<span class="k">namespace</span> <span class="n">UCLM</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">PersistentMessageI</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">PersistentMessage</span><span class="p">,</span>
			     <span class="k">public</span> <span class="n">IceUtil</span><span class="o">::</span><span class="n">AbstractMutexI</span><span class="o">&lt;</span><span class="n">IceUtil</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">PersistentMessageI</span><span class="p">();</span>
    <span class="n">PersistentMessageI</span><span class="p">(</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">,</span>		       
		       <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Current</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">read</span><span class="p">(</span><span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Current</span><span class="o">&amp;</span><span class="p">);</span>

  <span class="p">};</span>


  <span class="k">class</span> <span class="nc">MessageFactory</span> <span class="o">:</span>  <span class="k">virtual</span> <span class="k">public</span> <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectFactory</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">virtual</span> <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectPtr</span> <span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">();</span>
  <span class="p">};</span>

  
  <span class="k">class</span> <span class="nc">MessageInitializer</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">Freeze</span><span class="o">::</span><span class="n">ServantInitializer</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">initialize</span><span class="p">(</span><span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectAdapterPtr</span><span class="o">&amp;</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Identity</span><span class="o">&amp;</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&amp;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// __PersistentMessageI_h__</span>
</code></pre></div></div>
<p>Vemos un par de cosillas interesantes. En primer lugar, ya no incluye <i>Ice.h</i> sino <i>Freeze.h</i>, algo obvio por todos lados. También se incluye <i>IceUtil.h</i>, que necesitamos para poder heredar de la clase AbstractMutexI, algo que por cierto es otro requisito de los sirvientes. Para profundizar sobre la causa y demás, el capítulo dedicado a Freeze del Ice.Book tiene mucha información.</p>
<p>En cuanto a los métodos del sirviente, añadimos un constructor vacío, que será el que use la factoría. El resto es igual, excepte que en este caso, no es necesario añadir el atributo <i>message</i> puesto que lo heredamos de la clase de Ice.</p>
<p>Lo siguiente que vemos es la factoría que necesita el Evictor. Es sencilla, porque Ice nos provee los mecanismos para hacerla. Hereda de Ice::ObjectFactory e implementa dos métodos: <i>create()</i>, que será el que usemos, y <i>destroy()</i> que en este caso no es necesario.</p>
<p>Por último el inicializador, que como he dicho, no hace nada.</p>
<p>La parte de implementación:</p>
<p><u>PersistentMessageI.cpp</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>

<span class="cp">#include &lt;PersistentMessageI.h&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">UCLM</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="p">(){</span>
<span class="p">}</span>

<span class="n">UCLM</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="p">(</span><span class="n">string</span> <span class="n">msg</span><span class="p">){</span>

  <span class="n">message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">UCLM</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Current</span><span class="o">&amp;</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Event: ++ write&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">message</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span>
<span class="n">UCLM</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="o">::</span><span class="n">read</span><span class="p">(</span><span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Current</span><span class="o">&amp;</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Event: -- read&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Ice</span><span class="o">::</span><span class="n">ObjectPtr</span> 
<span class="n">UCLM</span><span class="o">::</span><span class="n">MessageFactory</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type</span><span class="p">){</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;MessageFactory::create(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;::UCLM::PersistentMessage&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PersistentMessageI</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> 
<span class="n">UCLM</span><span class="o">::</span><span class="n">MessageFactory</span><span class="o">::</span><span class="n">destroy</span><span class="p">()</span> <span class="p">{}</span>

<span class="kt">void</span> 
<span class="n">UCLM</span><span class="o">::</span><span class="n">MessageInitializer</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectAdapterPtr</span><span class="o">&amp;</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Identity</span><span class="o">&amp;</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectPtr</span><span class="o">&amp;</span><span class="p">){</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Como vimos, el código es muy similar. Sólo la factoría merece un poco de atención (por supuesto, esto son implementaciones sencillas, ad-hoc y pueden variar todo lo necesario, según las circunstancias). En nuestro caso, solo se comprueba el tipo y si coincide, se instancia un nuevo sirviente, usando el contructor vacío.</p>
<p>En lo que respecta al sirviente, no hay más. Los cambiós más interesantes están en el servidor.</p>
<p><u>PersistentServer.cpp</u></p>
<div>
<div class="highlight"><pre><code class="cpp"><span class="c1">// -*- mode: C++; coding: utf-8 -*-</span>
<span class="c1">// Messase service with persistency</span>

<span class="cp">#include &lt;PersistentMessageI.h&gt;</span>
<span class="cp">#include &lt;Freeze/Freeze.h&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">UCLM</span><span class="p">;</span>

<span class="cp">#define MAX_SERVS 100000</span>

<span class="k">class</span> <span class="nc">PersistentMessageServer</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">Ice</span><span class="o">::</span><span class="n">Application</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">PersistentMessageServer</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">dbName</span><span class="p">)</span> <span class="o">:</span>
    <span class="n">_dbName</span><span class="p">(</span><span class="n">dbName</span><span class="p">)</span> <span class="p">{</span> 
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">run</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

    <span class="n">_ic</span> <span class="o">=</span> <span class="n">communicator</span><span class="p">();</span>

    <span class="c1">// The object factories</span>

    <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectFactoryPtr</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageFactory</span><span class="p">;</span>
    <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">addObjectFactory</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">PersistentMessage</span><span class="o">::</span><span class="n">ice_staticId</span><span class="p">());</span>

    <span class="c1">// Create the object adapter</span>
    <span class="n">_adapter</span> <span class="o">=</span> <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">createObjectAdapterWithEndpoints</span><span class="p">(</span><span class="s">&quot;MServer&quot;</span><span class="p">,</span> <span class="s">&quot;tcp -h 127.0.0.1 -p 11112&quot;</span><span class="p">);</span>
    <span class="n">_adapter</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">();</span>

    <span class="c1">// Create the Freeze evictor</span>
    <span class="n">Freeze</span><span class="o">::</span><span class="n">ServantInitializerPtr</span> <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageInitializer</span><span class="p">;</span>
    <span class="n">_evictor</span> <span class="o">=</span> <span class="n">Freeze</span><span class="o">::</span><span class="n">createEvictor</span><span class="p">(</span><span class="n">_adapter</span><span class="p">,</span> <span class="n">_dbName</span><span class="p">,</span> <span class="s">&quot;dbfile&quot;</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
    <span class="n">_adapter</span><span class="o">-&gt;</span><span class="n">addServantLocator</span><span class="p">(</span><span class="n">_evictor</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="c1">// Create MAX_SERVS servants</span>
    <span class="n">UCLM</span><span class="o">::</span><span class="n">PersistentMessagePtr</span> <span class="n">serv</span><span class="p">;</span>
    <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectPrx</span> <span class="n">prx</span><span class="p">;</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Creating posts from 0 to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_SERVS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; ...&quot;</span><span class="p">;</span>
    <span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_SERVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="n">ostringstream</span> <span class="n">sid</span><span class="p">;</span>
      <span class="n">sid</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Post&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">Ice</span><span class="o">::</span><span class="n">Identity</span> <span class="n">id</span> <span class="o">=</span> <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">stringToIdentity</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_evictor</span><span class="o">-&gt;</span><span class="n">hasObject</span><span class="p">(</span><span class="n">id</span><span class="p">)){</span>
	<span class="n">serv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UCLM</span><span class="o">::</span><span class="n">PersistentMessageI</span><span class="p">(</span><span class="s">&quot;Message from &quot;</span> <span class="o">+</span> <span class="n">sid</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
	<span class="n">prx</span> <span class="o">=</span> <span class="n">_evictor</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; done.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Proxies at &#39;PostX -t:tcp -h 127.0.0.1 -p 11112&#39; where X is post number.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Waiting events...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="n">shutdownOnInterrupt</span><span class="p">();</span>
    <span class="n">_ic</span><span class="o">-&gt;</span><span class="n">waitForShutdown</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

<span class="nl">private:</span>
  <span class="n">string</span> <span class="n">_dbName</span><span class="p">;</span>
  <span class="n">Ice</span><span class="o">::</span><span class="n">ObjectAdapterPtr</span> <span class="n">_adapter</span><span class="p">;</span>
  <span class="n">Freeze</span><span class="o">::</span><span class="n">EvictorPtr</span> <span class="n">_evictor</span><span class="p">;</span>
  <span class="n">Ice</span><span class="o">::</span><span class="n">CommunicatorPtr</span> <span class="n">_ic</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> 
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

  <span class="n">PersistentMessageServer</span> <span class="n">srv</span><span class="p">(</span><span class="s">&quot;storage&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">srv</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>De nuevo, se incluye <i>Freeze.h</i> en vez de <i>Ice.h</i>. Además, al constructor del servidor se pasa el nombre del directorio que usará la base de datos. Este debe estar creado, o fallará. Lo siguiente que se hace es instanciar las factorías necesarias: en este caso sólo MessageFactory, pero serían necesarias tantas como clases de sirvientes persistentes quisiéramos.</p>
<p>Una vez creado el adaptador como de costumbre, creamos el Evictor, que es el que realmente se encarga de toda la faena. A él le añadiremos los sirvientes y a él le preguntaremos si los tiene ya. Al crearlo, lo añadimos al adaptador como el Servant Locator por defecto.</p>
<p><b>ACTUALIZACIÓN</b> En la versión 3.3 de Ice, han metido algunos cambios al respecto. Además de este Evictor, tenemos disponible otro transaccional. Si quieres usar este mismo, pero en la versión 3.3, el método para crearlo es <b>createBackgroundSaveEvictor</b>. Hay más info en la documentación de Ice, versión 3.3 obviamente.</p>
<p>Lo siguiente es crear los sirvientes. Si todavía no se han añadido a la base de datos, es necesario añadir el sirviente al Evictor para que lo haga. Pero, si el sirviente ya ha sido instanciado, no es necesario hacer nada. Por ello, lo primero que se hace es conseguir la identidad del objeto. Con esta, se pregunta al Evictor si tiene el objeto. Sólo en caso de que retorne falso instanciamos el sirviente y lo añadimos.</p>
<p>El resto es conocido. Compilamos enlazando con Freeze (<i>-lFreeze</i> con Gcc) y listo.</p>
<h2>Resultados</h2>
<p>Si lanzas ambos servidores, puedes apreciar la diferencia. El arranque del servidor sin Freeze es igual de rápido todas las veces, y ocupa mucha memoria <span class="caps">RAM</span>. El servidor persistente tarda más en iniciar la primera vez (puesto que tiene que añadir los sirvientes en la base de datos) pero es más ágil el resto de ocasiones. Además, ocupa bastante menos memoria.</p>
<p>En cuanto a la persistencia, puedes hacer una prueba. Lanza el servidor persistente, modifica alguno de sus mensajes, reinicialo y comprobarás que el mensaje mantiene las modificaciones que hiciste:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> ./PersistentServer &amp;     <span class="c">## Lanzado el servidor persistente</span>
<span class="go">[1] 6369</span>
<span class="gp">$</span> Creating posts from 0 to 100000 ... <span class="k">done</span>.
<span class="go">Proxies at &#39;PostX -t:tcp -h 127.0.0.1 -p 11112&#39; where X is post number.</span>
<span class="go">Waiting events...</span>

<span class="gp">$</span> ./Client <span class="s1">&#39;Post100 -t:tcp -h 127.0.0.1 -p 11112&#39;</span> write <span class="s2">&quot;hola&quot;</span>
<span class="gp">$</span> <span class="nb">fg</span>
<span class="go">./PersistentServer         ## Ctr+c para terminar el servidor</span>
<span class="gp">$</span> ./PersistentServer &amp;     <span class="c">## Lo arrancamos de nuevo</span>
<span class="go">[1] 6375</span>
<span class="gp">$</span> Creating posts from 0 to 100000 ... <span class="k">done</span>.
<span class="go">Proxies at &#39;PostX -t:tcp -h 127.0.0.1 -p 11112&#39; where X is post number.</span>

<span class="go">Waiting events...</span>

<span class="gp">$</span> ./Client <span class="s1">&#39;Post100 -t:tcp -h 127.0.0.1 -p 11112&#39;</span> <span class="nb">read</span>
<span class="go">COMMAND: read</span>
<span class="go">VALUE: &#39;hola&#39;</span>
<span class="gp">$</span> 
</code></pre></div></div>
<p>Y si no te lo crees, pruébalo tu mismo :-p.</p>
<p>Puedes jugar con las propiedades de Freeze para afinar mucho el resultado. En concreto, puedes modificar el número máximo de sirvientes activos. Una cosa a tener en cuenta es la penalización que se obtiene al tener que reactivar el sirviente cuando llega una petición, por ello, también puedes tener en un momento dado, algún sirviente que nunca sea puesto a dormir. Para estos y más detalles, te remito al Ice.Book.</p>
<h2>Referencias</h2>
<ol>
<li><a href="http://jerry.cs.uiuc.edu/~plop/plop2001/accepted_submissions/PLoP2001/pjain1/PLoP2001_pjain1_1.pdf">Patrón Evictor</a></li>
<li><a href="http://www.zeroc.com/download.html#doc">Manual de Ice: Ice.Book</a></li>
<li><a href="https://arco.esi.uclm.es/svn/public/samples/ice-hello/cpp/Freeze/">Código de los ejemplos</a></li>
</ol>
      </div>

      

      <hr/>

      <div class="pagination pagination-centered">
  <ul>
    
      <li class="prev"><a href="/opinion/2008-01-23/java-como-primer-lenguaje-mala-idea" title="Java como primer lenguaje: mala idea">&larr; Previous</a></li>
    

    <li><a href="/archive.html">Archive</a></li>

    
      <li class="next"><a href="/new/2008-01-24/ebay-y-el-software-libre" title="Ebay y el software libre...">Next &rarr;</a></li>
    
  </ul>
</div>


      <hr/>

      

<div id="show_comments"> [ <a onclick="show_comments();"> show comments </a> ] </div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'crysol'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
  </div>
</div>


	</div>
      </div>

      <hr/>

      <footer>
        <p>&copy; 2013 CRySoL
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
	  See <a href="https://github.com/CRySoL/CRySoL.github.io" target="_blank">site sources</a>.
	  <br/>
	  Generated at Sun Oct 06 08:47:12 +0200 2013
	</p>
      </footer>

    </div>

    
  </body>
</html>

