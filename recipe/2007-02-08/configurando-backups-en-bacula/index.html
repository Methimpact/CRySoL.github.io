
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Configurando backups en Bacula</title>
    
    <meta name="author" content="CRySoL">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js"></script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    

  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-narrow">
<!--
	  <a class="brand-image" href="/"><img class="brand-image" src="/assets/themes/twitter/logo.png"/></a>
-->
          <a class="brand" href="/">CRySoL</a>
          <ul class="nav">
            
            
            


  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/recipes.html">Recipes</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/users.html">Users</a></li>
      	
      
    
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="row-fluid">
	<div class="content">
          
<div class="sidebar span3">
  <div id="logo">
  <a href="/">
    <img src="/assets/images/logo.png" alt="logo"/>
  </a>
</div>

  <div class="metadata">
  <h2>this</h2>
  <ul>
    
      <li>author: 
  <a href="/users.html#int-0">
   int-0
  </a>


        
        <span class="author-photo">

  
    <img src="/assets/files/pictures/picture-8.jpg" width="48" alt="picture"/>
  

</span>

      </li>
      
    

    <li>created: 2007-02-08 </li>

    <li><a href="https://github.com/CRySoL/web.source/raw/master/_posts/migrated/2007-02-08-configurando-backups-en-bacula.html">source / <a href="https://github.com/CRySoL/web.source/edit/master/_posts/migrated/2007-02-08-configurando-backups-en-bacula.html">edit</a></li>

  
    <li>categories:
    
      <a href="/categories.html#recipe-ref">recipe</a>
    
    </li>
  

  
      <li>migrated&nbsp;from&nbsp;<a href="http://crysol.org/node/549">node/549</a></li>
  

  
    <li>tags:
    
      <a href="/tags.html#Arco-ref">Arco</a>
    
      <a href="/tags.html#security-ref">security</a>
    
    </li>
  
  </ul>

  
     
     
  

  
     
     
     <a class="tag-icon" href="/tags.html#Arco-ref">
        <img src="http://crysol.org/files/category_pictures/arco_3D_taxonomy.png" title="Arco" alt="Arco-icon"/>
     </a>
     
  
     
     
     <a class="tag-icon" href="/tags.html#security-ref">
        <img src="http://crysol.org/files/category_pictures/seguridad_taxonomy.png" title="security" alt="security-icon"/>
     </a>
     
  

  <!-- AddThis Button BEGIN -->
<div class="share addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Button END -->

</div>

<div class="related">
  <h2>related</h2>
  <ul>
    
    <li><a href="/recipe/2005-09-13/ssh-y-scp-para-acceder-a-equipos-remotos-sin-escribir-la-clave-public-key-authentication">SSH y SCP para acceder a equipos remotos sin escribir la clave (public key authentication)</a></li>
    
    <li><a href="/2005-09-24/acabo-de-registrarme-en-el-portal">Acabo de registrarme en el Portal</a></li>
    
    <li><a href="/2005-09-26/buenas-a-tods">Buenas a tod@s!</a></li>
    
    <li><a href="/tale/2005-09-26/instalacin-local-de-mambo-joomla-bajo-gnu-linux">Instalación local de Mambo / Joomla bajo GNU/Linux</a></li>
    
    <li><a href="/recipe/2005-09-27/acceso-a-red-cmpus-con-firefox-y-greasemonkey">Acceso a Red C@mpus con Firefox y Greasemonkey</a></li>
    
  </ul>
</div>

<div class="recent">
  <h2>recent</h2>
  <ul>
  
    <li><a href="/recipe/2013-09-23/virtualbox-vmdk-to-vdi">Converting .vmdk virtual disk to .vdi format from command line</a></li>
  
    <li><a href="/recipe/2013-09-19/ice35-deb-packages-from-zeroc">Installing the Ice-3.5 packages from ZeroC on Debian</a></li>
  
    <li><a href="/recipe/2013-09-03/DSO">Undertanding the DSO Link Change</a></li>
  
    <li><a href="/recipe/2013-08-11/hp-p1005-debian">HP LaserJet P1005 with Debian and the free driver</a></li>
  
    <li><a href="/recipe/2013-07-10/get-shell-user-without-shell">How to get a shell for a non-shell user</a></li>
  
  </ul>
</div>

</div>

<div class="node span9">
  <div class="page-header">
    <h1>Configurando backups en Bacula </h1>
  </div>

  <div class="row-fluid post-full">
    <div class="span12">
      <div class="content">
	<blockquote>Bien, ya vimos en una receta anterior como <a href="/node/400">instalar y configurar un sistema bacula</a> pero se nos quedó en el tintero lo más importante: ¿cómo indicar a bacula qué ficheros respaldar? ¿cuándo? ¿cómo?. En esta receta explicaremos cómo terminar de configurar un sistema bacula para su operación normal, recomendamos la lectura de la receta anterior sobre bacula... esta es como un "segundo capítulo".</blockquote>

<h2>Trabajos de backup</h2>

A la hora de configurar un servicio de backup, antes de modificar a diestro y siniestro archivos de backup, debemos pensar un poco de qué queremos hacer backup y, según su importancia, cuándo y cómo. En el <em>cómo</em> tenemos dos alternativas: completo y diferencial. Un backup completo respaldará toda la lista completa de ficheros a guardar, en cambio, un backup diferencial sólo guarda los ficheros modificados y nuevos respecto a la copia anterior (lo cual permite ahorrar espacio en cintas). Una base de datos tipo MySQL no tiene mucho sentido hacer respaldo diferencial puesto que se almacena toda ella en un único archivo binario y las más mínima modificación implicará el almacenado del fichero completo. En cambio, para una lista de ficheros de texto (un proyecto software, por ejemplo) los incrementales vienen muy bien puesto que pocas veces cambiarán todos los ficheros a la vez sino que se modifican poco a poco.

Para responder al <em>cuándo</em> debemos pensar en la importancia de los datos y en cuánto trabajo se va al garete si se perdieran los ficheros de un día para otro. Un conjunto de ficheros que se modifiquen a diario deberían respaldarse a diario, sin embargo, para ficheros que rara vez se modifiquen puede ser aceptable respaldarlos semanalmente, incluso mensualmente.

Tengamos por ejemplo un sistema Debian, en él tenemos un apache con su php y su drupal, a parte, tiene muchos usuarios que tienen sus proyectos en sus <em>homes</em>. ¿Cómo lo respaldaríamos? pues un ejemplo podría ser el siguiente: cada dos meses un backup del sistema completo (básicamente somos muy vagos y pasamos de reinstalarlo todo en caso de desastre, de esta forma podríamos restaurar el sistema completo sin mucho esfuerzo... aunque existen programas más adecuados para esto, ej: <em>mindi</em> y <em>mondo</em>); como la configuración del sistema es realmente más importante que el resto de archivos del sistema (puesto que un binario del sistema se encuentra a mano en el repositorio de paquetes, un archivo de configuración modificado por nosotros... pues no) realizaremos backups incrementales mansuales (tampoco se modifican taaanto) de los datos variables en la distribución, es decir <em>/etc</em> y parte de <em>/var</em>. También tenemos la base de datos MySQL, esto es más complicado puesto que no podemos hacer copia así como así de ella (¿que pasa si se modifica mientras se está haciendo backup?), la solución pasa por leerse la receta: <a href="http://crysol.inf-cr.uclm.es/node/219">Salvar (y recuperar) una base de datos MySQL</a> y hacer backup de eso (esto podría ser motivo de una nueva receta). Por último tenemos los <em>homes</em> de los usuarios, como queremos que pierdan poco en caso de desastre realizaremos backups incrementales diarios y completos semanales (esto facilita la recuperación).

Una vez decidido cómo va a funcionar nuestro servicio de backup sólo nos queda configurar bacula director para que lo haga... pues empecemos...

<h2>Resource FileSet</h2>

Este <em>resource</em> define la lista de ficheros a respaldar. También permite establecer opciones útiles, como por ejemplo calcular sumas <em>MD5</em> de verificación, o usar compresión <em>gz</em>, etc. Veamos un ejemplo:


<div>
<div class="highlight"><pre><code class="text">FileSet {
  Name = &quot;configuracion sistema&quot;
  Include {
    File = /etc
    File = /var
    Options {
      signature = MD5
    }
  }
  Exclude {
    File = /var/log
    File = /var/cache
    File = /var/tmp
  }
}
</code></pre></div>
</div>

Pues muy fácil, hemos creado un conjunto de ficheros, llamado <em>configuracion sistema</em> que incluye todos los ficheros y subdirectorios en <em>/etc</em>. De <em>/var</em> también metemos todo menos la "guarrería" :-P. Además, de los archivos que almacenemos se calculará la suma MD5 para comprobar que se salvaron correctamente. Se pueden usar comodines en plan <em>/usr/share/*/examples</em> y cosas así, tanto para <em>Include</em> como para <em>Exclude</em>. Se pueden especificar ficheros aislados, etc. Echad un vistazo al manual de bacula que vienen muchos ejemplos interesantes. El <em>FileSet</em> por defecto de bacula es el sistema de ficheros completo. Podemos crear los que queramos y posteriormente los identificaremos por su nombre.

<h2>Resource Schedule</h2>

Mediante estos <em>resources</em> se crean los intervalos de tiempo que emplearemos a la hora de crear los trabajos, al igual que los <em>FileSet</em> los identificaremos por un nombre, por ejemplo:


<div>
<div class="highlight"><pre><code class="text">Schedule {
  Name = &quot;CicloSemanal&quot;
  Run = Incremental mon-sat at 01:05
  Run = Full sun at 01:05
}
Schedule {
  Name = &quot;Diario&quot;
  Run = Full sun-sat at 23:10
}
</code></pre></div>
</div>

Hemos creado dos: <em>CicloSemanal</em> y <em>Diario</em>, como véis, en el primero se realizan backups incrementales de lunes (<b>mon</b>day) a sábado (<b>sat</b>urday) a las 01:05h y el domingo (<b>sun</b>day) a la misma hora uno completo. En el otro <em>schedule</em> se realizan backups completos a diario. Por defecto éstos son los <em>schedule</em> de bacula (salvo por la hora). El diario se emplea para hacer backup del catálogo de bacula.

<h2>Resource JobDefs</h2>

Aquí es donde finalmente pegaremos todo lo anterior para definir un trabajo completo de backup, si hemos entendido todo hasta aquí no hay mucho que explicar:


<div>
<div class="highlight"><pre><code class="text">JobDefs {
  Name = &quot;estado del sistema&quot;
  Enabled = yes
  Type = Backup
  Level = Incremental
  Client = nombre_resource_filedaemon
  FileSet = &quot;configuracion sistema&quot;
  Schedule = &quot;CicloSemanal&quot;
  Storage = nombre_resource_storage
  Messages = Standard
  Pool = Default
  Priority = 10
}
</code></pre></div>
</div>

Los campos <em>Client</em> y <em>Storage</em> se explicaron suficientemente en la receta anterior. El <em>Level</em> también se puede especificar aquí, pero si  se especifica en el <em>Schedule</em> se usará el de éste último. En <em>Priority</em> indicaremos un número, cuanto menor sea, más prioritario es el trabajo (en caso de que se envíen varias peticiones a un storage daemon, por ejemplo, se atienden por orden de prioridad). En cuanto al <em>Pool</em>... lo explicaremos más adelante :-P. Por defecto en bacula existen dos trabajos: <em>DefaultJob</em> que hace backups incrementales diarios de todo el sistema y completo los domingos, después de cada backup hace uno completo del catálogo.

<h2>Resource Job</h2>

Todos los campos de un <em>JobDef</em> son válidos para este <em>resource</em> también, la diferencia es que el anterior era la definición de un trabajo y este es el trabajo propiamente dicho. Si tenemos una buena definición, el trabajo quedaría como sigue:


<div>
<div class="highlight"><pre><code class="text">Job {
  Name = &quot;estado maquina&quot;
  JobDefs = &quot;estado del sistema&quot;
  Write Bootstrap = &quot;/var/lib/bacula/estado_maquina.bsr&quot;
}
</code></pre></div>
</div>

Con esto tendremos un trabajo en bacula llamado <em>estado maquina</em>, configurado como se indicó en <em>estado del sistema</em>. Además se creará una especie de <em>log</em> sobre el trabajo en el archivo indicado. Éste trabajo será el que podamos arrancar, parar, etc.

Ahora sólo nos queda saber una cosa, la organización del sistema de almacenamiento: los <em>pools</em>.

<h2>Resource Pool</h2>

En bacula se denomina <em>volume</em> a una cinta física (o archivo de backup). Un conjunto de <em>volumes</em> es un <em>pool</em>. Podemos definir varios para distintos propósitos, por ejemplo: en un <em>pool</em> almacenamos copias incrementales y en otro copias completas. Al instalar bacula se define un <em>pool</em> llamado <em>Default</em> de la siguiente forma:


<div>
<div class="highlight"><pre><code class="text">Pool {
  Name = Default
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 365 days
}
</code></pre></div>
</div>

El parámetro <em>Pool Type</em> indica el tipo (uy que listo soy!), el único implementado en bacula es <em>Backup</em>, tienen intención de soportar otros como <em>Migration</em>, <em>Cloned</em>, etc. Los últimos tres parámetros tienen que ver con el reciclaje de cintas. Si no quedan mas volúmenes y se permite su reciclado, cuando un volumen sea más antiguo que su periodo de retención (un año en el ejemplo) será sobreescrito por backups nuevos.

Hay que decir que en un <em>Pool</em> podemos especificar parámetros como <em>Client</em> o <em>Storage</em>, que serían los que utilizaría bacula a menos se especificase lo contrario en otra <em>resource</em> "superior". Así pues podemos definir una especie de "valores por defecto" en una <em>pool</em>.

Si nos fijamos bien, en ningún parámetro se especifica qué volúmenes forman parte de esta <em>pool</em>... ¿cómo se hace eso? esto ya debemos hacerlo desde la <em>bacula console</em>. En el caso de las cintas se deben identificar con una etiqueta software que ponemos a las cintas con el comando <em>label</em>/<em>relabel</em> y posteriormente el comando <em>add</em> para añadir un volumen a un <em>pool</em>:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*label</span>
<span class="go">Automatically selected Catalog: MyCatalog</span>
<span class="go">Using Catalog &quot;MyCatalog&quot;</span>
<span class="go">The defined Storage resources are:</span>
<span class="go">     1: File</span>
<span class="go">     2: respaldadora-sd</span>
<span class="go">Select Storage resource (1-2): 2</span>
<span class="go">Enter new Volume name: cinta01</span>
<span class="go">*add</span>
<span class="go">You probably don&#39;t want to be using this command since it</span>
<span class="go">creates database records without labeling the Volumes.</span>
<span class="go">You probably want to use the &quot;label&quot; command.</span>
<span class="go">Automatically selected Catalog: MyCatalog</span>
<span class="go">Using Catalog &quot;MyCatalog&quot;</span>
<span class="go">Automatically selected Pool: Default</span>
<span class="go">The defined Storage resources are:</span>
<span class="go">     1: File</span>
<span class="go">     2: respaldadora-sd</span>
<span class="go">Select Storage resource (1-2): 2</span>
<span class="go">Enter number of Volumes to create. 0=&gt;fixed name. Max=1000: 0</span>
<span class="go">Enter Volume name: cinta01</span>
</code></pre></div>
</div>

Podemos facilitarnos la vida un poco más si en el storage daemon, los <em>resource</em> tipo <em>device</em> que empleemos tienen la opción <em>LabelMedia = yes</em>, esto hará que bacula vaya etiquetando las cintas limpias o reciclables según vaya necesitándolas, es ese caso no necesitamos ejecutar <em>label</em> para nada.

Pues bien, con nuestro <em>pool</em> bien creado y los <em>jobs</em> bien definidos ya tenemos nuestro servicio de backup funcionando... ahora a esperar que no tengamos que usarlo!

<h2>Apéndice A: configuración completa de un bacula director</h2>

Para hacer una receta de copia-pega vamos a incluír un archivo de configuración completo para el bacula-director, ya sabéis, el archivo <tt>/etc/bacula/bacula-dir.conf</tt>:


<div>
<div class="highlight"><pre><code class="text">Director {
  Name = respaldadora-dir
  DIRport = 9101
  QueryFile = &quot;/etc/bacula/scripts/query.sql&quot;
  WorkingDirectory = &quot;/var/lib/bacula&quot;
  PidDirectory = &quot;/var/run/bacula&quot;
  Maximum Concurrent Jobs = 1
  Password = &quot;password_para_respaldadora-dir&quot;
  Messages = Daemon
  DirAddress = 127.0.0.1 # Esto obliga a que las consolas bacula solo se puedan ejecutar desde localhost
}

Client {
  Name = importante-fd
  Address = 192.168.0.1
  FDPort = 9102
  Catalog = MyCatalog
  Password = &quot;password_para_respaldadora-dir&quot;
  File Retention = 30 days
  Job Retention = 6 months
  AutoPrune = yes
}

Storage {
  Name = File
  Address = 192.168.0.2
  SDPort = 9103
  Password = &quot;password_para_respaldadora-dir&quot;
  Device = FileStorage
  Media Type = File
}

Storage {
  Name = respaldadora-sd
  Address = 192.168.0.2
  SDPort = 9103
  Password = &quot;password_para_respaldadora-dir&quot;
  Device = Autochanger
  Media Type = DDS-4
  Autochanger = yes
}

Catalog {
  Name = MyCatalog
  dbname = bacula; DB Address = &quot;&quot; ; user = bacula; password = &quot;password_de_bbdd&quot;
}

Messages {
  Name = Standard
  mailcommand = &quot;/usr/lib/bacula/bsmtp -h localhost -f \&quot;\(Bacula\) %r\&quot; -s \&quot;Bacula: %t %e of %c %l\&quot; %r&quot;
  operatorcommand = &quot;/usr/lib/bacula/bsmtp -h localhost -f \&quot;\(Bacula\) %r\&quot; -s \&quot;Bacula: Intervention needed for %j\&quot; %r&quot;
  mail = root@localhost = all, !skipped
  operator = root@localhost = mount
  console = all, !skipped, !saved
  append = &quot;/var/lib/bacula/log&quot; = all, !skipped
}

Messages {
  Name = Daemon
  mailcommand = &quot;/usr/lib/bacula/bsmtp -h localhost -f \&quot;\(Bacula\) %r\&quot; -s \&quot;Bacula daemon message\&quot; %r&quot;
  mail = root@localhost = all, !skipped
  console = all, !skipped, !saved
  append = &quot;/var/lib/bacula/log&quot; = all, !skipped
}

Pool {
  Name = Default
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 365 days
}

Console {
  Name = respaldadora-mon
  Password = &quot;password_para_respaldadora-mon&quot;
  CommandACL = status, .status
}

JobDefs {
  Name = &quot;Usuarios&quot;
  Enabled = yes
  Type = Backup
  Level = Incremental
  Client = importante-fd
  FileSet = &quot;homes&quot;
  Schedule = &quot;Semanal&quot;
  Storage = respaldadora-sd
  Messages = Standard
  Pool = Default
  Priority = 10
}

JobDefs {
  Name = &quot;Sistema&quot;
  Enabled = yes
  Type = Backup
  Client = importante-fd
  FileSet = &quot;sistema sin homes&quot;
  Schedule = &quot;Mensual&quot;
  Storage = respaldadora-sd
  Messages = Standard
  Pool = Default
  Priority = 10
}

Job {
  Name = &quot;Backup Usuarios&quot;
  JobDefs = &quot;Usuarios&quot;
  Write Bootstrap = &quot;/var/lib/bacula/importante_homes.bsr&quot;
}

Job {
  Name = &quot;Backup Sistema&quot;
  JobDefs = &quot;Sistema&quot;
  Write BootStrap = &quot;/var/lib/bacula/importante_sistema.bsr&quot;
}

FileSet {
  Name = &quot;homes&quot;
  Include {
    File = /home
    Options {
      signature = MD5
    }
  }
  Exclude {
    File = *.avi
    File = *.iso
    File = *.mp3
    File = ~*
    File = /home/*/tmp
  }
}

FileSet {
  Name = &quot;Sistema sin homes&quot;
  Include {
    File = /
    Options {
      signature = MD5
    }
  }
  Exclude {
    File = /home
    File = /var/tmp
    File = /var/log
    File = /var/cache
    File = /var/run
    File = /dev
    File = /proc
    File = /sys
    File = /lost+found
}

Schedule {
  Name = &quot;Semanal&quot;
  Run = Incremental mon-sat at 01:05
  Run = Full sun at 01:05
}

Schedule {
  Name = &quot;Mensual&quot;
  Run = Full on 1 at 01:05
}
</code></pre></div>
</div>

Usar este archivo tal cual no es muy recomendable por varias razones, la más importante es que <b>no hace backup del catálogo de bacula</b>, el archivo por defecto de bacula <b>si</b> lo hace; por otro lado, tampoco tiene el trabajo de restauración de ficheros (lo cual puede ser peor...), por tanto coged las partes que os interesen. ;-)

<h2>Apéndice B: Comandos útiles en la consola de bacula</h2>

El más importante:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*help</span>
</code></pre></div>
</div>

;-) ...y después:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*m</span>
</code></pre></div>
</div>

Este último te muestra los mensajes que hubiese pendientes, tales como: <em>Job completed</em> o <em>error at XXXX</em>... lo que sea. También podemos ver que tal van las cosas en bácula:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*status</span>
</code></pre></div>
</div>

Nos preguntará de qué queremos el estado, le decimos que 4 (all) y listo. 

Para saber qué se va a respaldar exactamente podemos <em>estimar</em> el trabajo, fácil:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*estimate</span>
<span class="go">*estimate listing</span>
</code></pre></div>
</div>

Primero aparecerá una lista de los trabajos configurados, elegiremos el que queramos estimar, es el primer caso nos aparecerá el número de ficheros que respaldará y cuanto ocupara la copia. En el segundo, a parte de eso, nos saldrán todos los ficheros.

Para mostrar un listado de los volúmenes que tenemos configurados:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*list volumes</span>
</code></pre></div>
</div>

Esto mostrará todos los volúmenes del <em>pool</em> actual, cuánto llevan ocupado, retenido, etc. Si queremos saber qué tal van los trabajos también usamos <em>list</em>, pero esta vez:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*list jobs</span>
</code></pre></div>
</div>

Nos aparecerá un resumen de lo más chulo: trabajos terminados, erróneos, etc.
Si queremos forzar la ejecución de un trabajo:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">*run</span>
</code></pre></div>
</div>

Nos aparecerá una lista de trabajos y seleccionaremos el que queramos, automáticamente pasará a la lista de trabajos y de ahí a ejecutarse.

Como véis la consola no es nada difícil... es hasta intuitivo... ;-)

<h2>Apéndice C: Recuperar archivos respaldados</h2>

Resulta que tenéis vuestro servicio de backup funcionando y (Santa Tecla no lo quiera) resulta que perdéis vuestros ficheros. Pues nada... no preocuparse... arrancamos la <em>bacula console</em> y ejecutamos lo siguiente:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">* restore</span>
<span class="go">First you select one or more JobIds that contain files</span>
<span class="go">to be restored. You will be presented several methods</span>
<span class="go">of specifying the JobIds. Then you will be allowed to</span>
<span class="go">select which files from those JobIds are to be restored.</span>
<span class="go">To select the JobIds, you have the following choices:</span>
<span class="go">     1: List last 20 Jobs run</span>
<span class="go">     2: List Jobs where a given File is saved</span>
<span class="go">     3: Enter list of comma separated JobIds to select</span>
<span class="go">     4: Enter SQL list command</span>
<span class="go">     5: Select the most recent backup for a client</span>
<span class="go">     6: Select backup for a client before a specified time</span>
<span class="go">     7: Enter a list of files to restore</span>
<span class="go">     8: Enter a list of files to restore before a specified time</span>
<span class="go">     9: Find the JobIds of the most recent backup for a client</span>
<span class="go">    10: Find the JobIds for a backup for a client before a specified time</span>
<span class="go">    11: Enter a list of directories to restore for found JobIds</span>
<span class="go">    12: Cancel</span>
<span class="go">Select item:  (1-12):</span>
</code></pre></div>
</div>

Pues nada... seleccionaremos lo que deseemos, una buena opción es la 5: <em>Select the most recent backup for a client</em>, es decir: seleccionar el backup más reciente de un cliente. Seleccionamos esto y nos apareceran los <em>FileSets</em> disponibles:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">Automatically selected Client: arco-fd</span>
<span class="go">The defined FileSet resources are:</span>
<span class="go">     1: homes</span>
<span class="go">     2: Sistema sin homes</span>
<span class="go">Select FileSet resource (1-2):</span>
</code></pre></div>
</div>

Ahora seleccionaremos el primero (o el que necesitéis), después de eso bacula buscará en qué cintas está lo que buscamos y se hará sus cuentas (buscará todos aquellos ficheros que deba recuperar) y nos mostrará una <em>shell</em> al estilo <em>bash</em>:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">You are now entering file selection mode where you add (mark) and</span>
<span class="go">remove (unmark) files to be restored. No files are initially added, unless</span>
<span class="go">you used the &quot;all&quot; keyword on the command line.</span>
<span class="go">Enter &quot;done&quot; to leave this mode.</span>
<span class="go">cwd is: /</span>
<span class="gp">$</span>
</code></pre></div>
</div>

Si introducimos <em>help</em> veremos una lista de comandos disponibles, tenemos <em>cd</em> y <em>ls</em> de toda la vida (navegaremos por todos los ficheros posibles para recuperar según lo que eligiésemos). Luego tenemos <em>mark</em> y <em>markdir</em> para marcar (recursivamente) archivos a recuperar, los archivos que con <em>ls</em> aparezca un asterisco delante, significa que está marcado (en caso contrario no está seleccionado para recuperar).


<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> mark *
<span class="go">94,668 files marked.</span>
</code></pre></div>
</div>

Con <em>lsmark</em> mostramos sólo archivos marcados. Podemos desmarcarlos con <em>unmark</em> y <em>unmarkdir</em>. También podemos estimar la cantidad de volumen que llevamos marcado con <em>estimate</em>. Cuando lo tengamos todo a punto:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> <span class="k">done</span>
<span class="go">Bootstrap records written to /var/lib/bacula/stallman-dir.restore.3.bsr</span>
<span class="go">The job will require the following</span>
<span class="go">   Volume(s)                 Storage(s)                SD Device(s)</span>
<span class="go">===========================================================================</span>
<span class="go">   cinta0004                 stallman-sd               Autochanger</span>
<span class="go">94,668 files selected to be restored.</span>
<span class="go">Run Restore job</span>
<span class="go">JobName:    RestoreFiles</span>
<span class="go">Bootstrap:  /var/lib/bacula/respaldadora-dir.restore.3.bsr</span>
<span class="go">Where:      /tmp/bacula-restores</span>
<span class="go">Replace:    always</span>
<span class="go">FileSet:    Full Set</span>
<span class="go">Client:     importante-fd</span>
<span class="go">Storage:    respaldadora-sd</span>
<span class="go">When:       2007-03-19 21:02:49</span>
<span class="go">Catalog:    MyCatalog</span>
<span class="go">Priority:   10</span>
<span class="go">OK to run? (yes/mod/no):</span>
</code></pre></div>
</div>

Si decimos que <em>yes</em> lanzará el trabajo que se ejecutará cuanto antes. Podemos cambiar el directorio destino donde guardará todos los archivos recuperados (en el ejemplo <tt>/tmp/bacula-restores</tt>) introduciendo <em>mod</em>, en cuyo caso mostrará una lista de parámetros modificables. Hay que decir que este directorio es local a la máquina que ejecuta el <em>client</em> (un <em>bacula file daemon</em>) que aparece en el resumen y que seleccionamos al principio del proceso de restauración.

<h2>Enlaces</h2>

La receta <a href="/node/400">Copias de seguridad con Bacula en sistemas GNU</a> y sus enlaces... :-P

<a href="http://www.lucasmanual.com/mywiki/Bacula">Bacula: The Open Source Commercial Backup Solution </a>

      </div>

      

      <hr/>

      <div class="pagination pagination-centered">
  <ul>
    
      <li class="prev"><a href="/art/2007-02-06/arte-linuxero" title="Arte "linuxero"...">&larr; Previous</a></li>
    

    <li><a href="/archive.html">Archive</a></li>

    
      <li class="next"><a href="/2007-02-09/fallos-en-el-repositorio-de-mesa-a-da-9-de-febrero-de-2007-drm_vblank_secondary" title="Fallos en el repositorio de Mesa (a día 9 de Febrero de 2007) DRM_VBLANK_SECONDARY">Next &rarr;</a></li>
    
  </ul>
</div>


      <hr/>

      

<div id="show_comments"> [ <a onclick="show_comments();"> show comments </a> ] </div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'crysol'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
  </div>
</div>


	</div>
      </div>

      <hr/>

      <footer>
        <p>&copy; 2013 CRySoL
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
	  See <a href="https://github.com/CRySoL/CRySoL.github.io" target="_blank">site sources</a>.
	  <br/>
	  Generated at Tue Sep 24 19:24:01 +0200 2013
	</p>
      </footer>

    </div>

    
  </body>
</html>

