
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Creating a virtual grid with libvirt + debian preseeds + puppet + IceGrid</title>
    
    <meta name="author" content="CRySoL">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js"></script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    

  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-narrow">
<!--
	  <a class="brand-image" href="/"><img class="brand-image" src="/assets/themes/twitter/logo.png"/></a>
-->
          <a class="brand" href="/">CRySoL</a>
          <ul class="nav">
            
            
            


  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/recipes.html">Recipes</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/users.html">Users</a></li>
      	
      
    
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="row-fluid">
	<div class="content">
          
<div class="sidebar span3">
  <div id="logo">
  <a href="/">
    <img src="/assets/images/logo.png" alt="logo"/>
  </a>
</div>

  <div class="metadata">
  <h2>this</h2>
  <ul>
    
      <li>author: 
  <a href="/users.html#david_villa">
   david.villa
  </a>


        
        <span class="author-photo">

  <img src="http://www.gravatar.com/avatar/41aae9eabb1ef8e1cb8ab5619af82083?s=48" alt="gravatar"/>

</span>

      </li>
      
      <li>
        <!-- AddThis Follow BEGIN -->
<span class="addthis_toolbox addthis_default_style">

<a class="addthis_button_twitter_follow" addthis:userid="david_vi11a"></a>

</span>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Follow END -->

      </li>
      
      
      <li>
        <!-- AddThis Follow BEGIN -->
<span class="addthis_toolbox addthis_default_style">

<a class="addthis_button_google_plusone_badge" g:plusone:href="https://plus.google.com/106836499723740718510/"></a>

</span>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Follow END -->

      </li>
      
    

    <li>created: 2013-03-19 </li>

    <li><a href="https://github.com/CRySoL/web.source/raw/master/_posts/migrated/2013-03-19-creating-a-virtual-grid-with-libvirt-debian-preseeds-puppet-icegrid.textile">source / <a href="https://github.com/CRySoL/web.source/edit/master/_posts/migrated/2013-03-19-creating-a-virtual-grid-with-libvirt-debian-preseeds-puppet-icegrid.textile">edit</a></li>

  
    <li>categories:
    
      <a href="/categories.html#recipe-ref">recipe</a>
    
    </li>
  

  
      <li>migrated&nbsp;from&nbsp;<a href="http://crysol.org/node/1695">node/1695</a></li>
  

  
    <li>tags:
    
      <a href="/tags.html#Ice-ref">Ice</a>
    
      <a href="/tags.html#Debian-ref">Debian</a>
    
    </li>
  
  </ul>

  
     
     
  

  
     
     
     <a class="tag-icon" href="/tags.html#Ice-ref">
        <img src="http://crysol.org/files/category_pictures/zeroc_logo.png" title="Ice" alt="Ice-icon"/>
     </a>
     
  
     
     
     <a class="tag-icon" href="/tags.html#Debian-ref">
        <img src="http://crysol.org/files/category_pictures/debian.png" title="Debian" alt="Debian-icon"/>
     </a>
     
  

  <!-- AddThis Button BEGIN -->
<div class="share addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Button END -->

</div>

<div class="related">
  <h2>related</h2>

  <ul>
   
   
      
        
          
          <li><a href="/recipe/2013-12-04/authentication-in-IceGrid">¿Cómo proporcionar un mecanismo de autenticación a IceGrid?</a></li>
        
      
        
          
          <li><a href="/recipe/2013-09-19/ice35-deb-packages-from-zeroc">Installing the Ice-3.5 packages from ZeroC on Debian</a></li>
        
      
        
      
        
          
          <li><a href="/recipe/2011-02-28/compilacin-cruzada-de-iceservices-para-arquitecturas-arm">Compilación cruzada de IceServices para arquitecturas ARM</a></li>
        
      
        
          
          <li><a href="/recipe/2010-03-26/cmake-compilando-aplicaciones-zeroc-ice">CMake: Compilando aplicaciones ZeroC Ice</a></li>
        
      
        
          
          <li><a href="/recipe/2009-10-01/java-ice-netbeans-eclipse-y-otras-malas-hierbas">Java, Ice, Netbeans, Eclipse y otras malas hierbas</a></li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
   
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
   
  </ul>

  
</div>

<div class="recent">
  <h2>recent</h2>
  <ul>
  
    <li><a href="/recipe/2014-10-08/introduction-to-ogre3d">Introduccion a Ogre3D</a></li>
  
    <li><a href="/recipe/2013-12-04/authentication-in-IceGrid">¿Cómo proporcionar un mecanismo de autenticación a IceGrid?</a></li>
  
    <li><a href="/recipe/2013-11-29/fix-damaged-var-lib-dpkg-available">Fixing damaged /var/lib/dpkg/available</a></li>
  
    <li><a href="/recipe/2013-11-15/reading-a-property-file-with-augeas">Reading a properties file with augeas</a></li>
  
    <li><a href="/recipe/2013-10-28/file-grain-sudo">Fine-grain sudo</a></li>
  
  </ul>
</div>

</div>

<div class="node span9">
  <div class="page-header">
    <h1>Creating a virtual grid with libvirt + debian preseeds + puppet + IceGrid </h1>
  </div>

  <div class="row-fluid post-full">
    <div class="span12">
      <div class="content">
	<p>This recipe explain how to build a grid composed by 6 debian virtual machines running IceGrid. Once the setup is done, the whole process may be executed with absolutelly no user interaction. The process takes advantage from libvirt (for virtual machine installation), debian preseds (for unattended installation) and puppet (for configuration management).</p>
<p>The resulting virtual grid is suitable to make tesing and continuous integration for distributed applications (using ZeroC IceGrid in this case).</p>
<p><!--break--></p>
<p><span class="caps">WARNING</span>: there is pending work in this post.</p>
<h2>ingredients</h2>
<p>Install next packages:</p>
<ul>
	<li>libvirt-bin</li>
	<li>virtinst</li>
	<li>icegrid-gui</li>
	<li>libguestfs-tools</li>
	<li>guestfish</li>
</ul>
<h2>guestfs</h2>
<p>Some scripts need guestfs. This requires a supermin appliance. To build it execute:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> update-guestfs-appliance 
</code></pre></div></div>
<h2>virtual network</h2>
<p>We will use the next network definition. Write it in a file named <code>net-grid.xml</code>:</p>
<p>[ <a href="https://bitbucket.org/DavidVilla/libvirt-toys/src/tip/grid/net-grid.xml">net-grid.xml</a> ]</p>
<div>
<div class="highlight"><pre><code class="text">&lt;network&gt;
  &lt;name&gt;grid&lt;/name&gt;
  &lt;forward mode=&#39;nat&#39;/&gt;
  &lt;bridge name=&#39;virbr1&#39; stp=&#39;on&#39; delay=&#39;0&#39;/&gt;
  &lt;mac address=&#39;52:54:00:6F:5E:D8&#39;/&gt;
  &lt;dns&gt;
    &lt;host ip=&#39;192.168.1.1&#39;&gt;
      &lt;hostname&gt;node0&lt;/hostname&gt;
      &lt;hostname&gt;puppet&lt;/hostname&gt;
    &lt;/host&gt;
  &lt;/dns&gt;
  &lt;ip address=&#39;192.168.1.1&#39; netmask=&#39;255.255.255.0&#39;&gt;
    &lt;dhcp&gt;
      &lt;range start=&#39;192.168.1.2&#39; end=&#39;192.168.1.254&#39;/&gt;
      &lt;host mac=&quot;00:AA:00:00:00:11&quot; name=&quot;node1&quot; ip=&#39;192.168.1.11&#39;/&gt;
      &lt;host mac=&quot;00:AA:00:00:00:12&quot; name=&quot;node2&quot; ip=&#39;192.168.1.12&#39;/&gt;
      &lt;host mac=&quot;00:AA:00:00:00:13&quot; name=&quot;node3&quot; ip=&#39;192.168.1.13&#39;/&gt;
      &lt;host mac=&quot;00:AA:00:00:00:14&quot; name=&quot;node4&quot; ip=&#39;192.168.1.14&#39;/&gt;
      &lt;host mac=&quot;00:AA:00:00:00:15&quot; name=&quot;node5&quot; ip=&#39;192.168.1.15&#39;/&gt;
      &lt;host mac=&quot;00:AA:00:00:00:16&quot; name=&quot;node6&quot; ip=&#39;192.168.1.16&#39;/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre></div></div>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> virsh net-define net-grid.xml
<span class="gp">#</span> virsh net-start grid
</code></pre></div></div>
<h2>node1 instalation</h2>
<p>We make a minimal debian installation and then we will make 5 clones. Next script automates the installation process. Remember you need the <a href="https://bitbucket.org/DavidVilla/libvirt-toys/raw/tip/debian-pressed/preseed.cfg">preseed.cfg</a> file in current directory (the script web-servers it using Python).</p>
<p>[ <a href="https://bitbucket.org/DavidVilla/libvirt-toys/src/tip/grid/install.sh">install.sh</a> ]</p>
<div>
<div class="highlight"><pre><code class="text">#!/bin/bash --
export LIBVIRT_DEFAULT_URI=qemu:///system

name=node1

virsh destroy $name
virsh undefine $name

python -m SimpleHTTPServer 80 &amp;

virt-install \
  --debug \
  --name=$name \
  --ram=512 \
  --disk ./$name.img,size=1.2,sparse=true \
  --location=http://babel.esi.uclm.es/debian/dists/testing/main/installer-i386 \
  --network=network=grid,mac=00:AA:00:00:00:11 \
  --extra-args=&quot;\
    auto=true priority=critical vga=normal hostname=$name \
    url=http://192.168.122.1/preseed.cfg&quot;
</code></pre></div></div>
<h2>clonning nodes</h2>
<p>Once the installation has finished, we can make clones. To build clean clones is required to remove some settings established during installation. Thanks to guestfs it is easy to remove than settings using <code>libguestfs-tools</code>:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> <span class="nb">export </span><span class="nv">LIBVIRT_DEFAULT_URI</span><span class="o">=</span>qemu:///system
<span class="gp">#</span> virt-sysprep -d node1 --enable udev-persistent-net
</code></pre></div></div>
<p>This is a good moment to set the puppet agent execution using cron. To make this just copy a crontab file in the guest fs:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> <span class="nb">export </span><span class="nv">LIBVIRT_DEFAULT_URI</span><span class="o">=</span>qemu:///system
<span class="gp">#</span> guestfish --rw -i -d node1 copy-in puppet/puppet /etc/cron.d/
</code></pre></div></div>
<p>You need the <a href="https://bitbucket.org/DavidVilla/libvirt-toys/src/tip/grid/puppet">puppet</a> directory.</p>
<p>It is time to clone:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">export LIBVIRT_DEFAULT_URI=qemu:///system</span>
<span class="go">for i in $(seq 2 6); do</span>
<span class="go">    virt-clone --original node1 --name node$i --file ./node$i.img --mac 00:AA:00:00:00:1$i</span>
<span class="go">    virt-sysprep -d node$i --enable hostname --hostname node$i</span>
<span class="go">done</span>
</code></pre></div></div>
<p>The script set the mac address and hostname in the range node2 to node6. Due the network specification, these hosts will get predefined IP addresses.</p>
<h2>starting nodes</h2>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="go">export LIBVIRT_DEFAULT_URI=qemu:///system</span>

<span class="go">for dom in $(virsh list --all --name); do</span>
<span class="go">    virsh start $dom</span>
<span class="go">done</span>
</code></pre></div></div>
<h2>puppetmaster</h2>
<p>You need to install puppetmaster in the host machine. The next command configure master to autosign agent certificates. That is obviously not secure, but convenient for our purposes here. As soon as nodes send cert request, master will sign them and then all of them are ready to apply the manifest.</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> hostname puppet
<span class="gp">#</span> apt-get install puppetmaster
<span class="gp">#</span> <span class="nb">echo</span> <span class="s1">&#39;*&#39;</span> &gt; /etc/puppet/autosign.conf
<span class="gp">#</span> service puppetmaster restart
</code></pre></div></div>
<h2>writing the puppet manifest</h2>
<p>Our initial manifest is pretty simple. We want to install some packages: ice34-services, psmisc and configure the icegrid-node service. You must copy next file in <code>/etc/puppet/manifests/site.pp</code></p>
<div>
<div class="highlight"><pre><code class="text">package {&#39;ice34-services&#39;:
  ensure =&gt; present,
}

package {&#39;psmisc&#39;:
  ensure =&gt; present,
}

file {&#39;/etc/icegrid&#39;:
  ensure =&gt; &#39;directory&#39;,
  mode =&gt; 755,
  owner =&gt; root,
}

file {[&#39;/var/icegrid&#39;, &#39;/var/icegrid/db&#39;]:
  ensure =&gt; &#39;directory&#39;,
  mode =&gt; 755,
  owner =&gt; root,
}

file {&#39;/etc/icegrid/node.config&#39;:
  mode =&gt; 644,
  owner =&gt; root,
  content =&gt; &quot;
Ice.Default.Locator=IceGrid/Locator -t:tcp -h node0 -p 4061
IceGrid.Node.Name=${hostname}
IceGrid.Node.Data=/var/icegrid/db
IceGrid.Node.Endpoints=tcp
&quot;
}

service {&#39;icegridnode&#39;:
  provider =&gt; &#39;base&#39;,
  ensure =&gt; running,
  start =&gt; &#39;/usr/bin/icegridnode --Ice.Config=/etc/icegrid/node.config &amp;&#39;,
  stop  =&gt; &#39;killall icegridnode&#39;,
  status =&gt; &#39;pgrep icegridnode&#39;,
  require =&gt; Package[&#39;ice34-services&#39;, &#39;psmisc&#39;]
}
</code></pre></div></div>
<p>This is very rough manifest, but enough for this case.</p>
<h2>IceGrid configuration</h2>
<p>You can see in the <code>sites.pp</code> manifest that we are configuring icegrid nodes to connect to the IceGrid Registry in <code>node0</code>. node0 is an alias for the host computer private IP address (see <code>net-grid.xml</code>). The manifest create required directories and files to get icegridnode running. Note this is not the right way to execute the icegridnode service. It should have a init.d script to get easily managed with puppet.</p>
<p>You must execute an IceGrid Registry in the host computer. You will need the file <a href="https://bitbucket.org/DavidVilla/libvirt-toys/src/tip/grid/icegrid/registry.config">registry.config</a>.</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> icegrid-node --Ice.Config<span class="o">=</span>icegrid/registry.config
</code></pre></div></div>
<p>Then, you may connect to the registry with:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> icegrid-gui --Ice.Config<span class="o">=</span>icegrid/locator.config
</code></pre></div></div>
<p>If all is working fine, you will see the 6 nodes in the &#8220;live deployment&#8221; tab of icegrid-gui.</p>
<h2>references</h2>
<ul>
	<li>Thanks to <a href="http://magmax.org">magmax</a> for its puppet support.</li>
</ul>
      </div>

      

      <hr/>

      <div class="pagination pagination-centered">
  <ul>
    
      <li class="prev"><a href="/recipe/2013-03-19/adios-google-reader-hola-tiny-tiny-rss" title="Adios Google Reader, Hola Tiny Tiny RSS">&larr; Previous</a></li>
    

    <li><a href="/archive.html">Archive</a></li>

    
      <li class="next"><a href="/recipe/2013-04-11/emacs-pills-compilation-feedback-with-colors" title="emacs-pills: compilation feedback with colors">Next &rarr;</a></li>
    
  </ul>
</div>


      <hr/>

      

<div id="show_comments"> [ <a onclick="show_comments();"> show comments </a> ] </div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'crysol'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
  </div>
</div>


	</div>
      </div>

      <hr/>

      <footer>
        <p>&copy; 2014 CRySoL
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
	  See <a href="https://github.com/CRySoL/web.source" target="_blank">site sources</a>.
	  <br/>
	  Generated at Wed Oct 22 13:12:44 +0200 2014
	</p>
      </footer>

    </div>

    
  </body>
</html>

