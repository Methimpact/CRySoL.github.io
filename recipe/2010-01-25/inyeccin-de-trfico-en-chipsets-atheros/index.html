
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Inyección de tráfico en chipsets Atheros</title>
    
    <meta name="author" content="CRySoL">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js"></script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    

  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-narrow">
<!--
	  <a class="brand-image" href="/"><img class="brand-image" src="/assets/themes/twitter/logo.png"/></a>
-->
          <a class="brand" href="/">CRySoL</a>
          <ul class="nav">
            
            
            


  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/recipes.html">Recipes</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/users.html">Users</a></li>
      	
      
    
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="row-fluid">
	<div class="content">
          
<div class="sidebar span3">
  <div id="logo">
  <a href="/">
    <img src="/assets/images/logo.png" alt="logo"/>
  </a>
</div>

  <div class="metadata">
  <h2>this</h2>
  <ul>
    
      <li>author: 
  <a href="/users.html#int-0">
   int-0
  </a>


        
        <span class="author-photo">

  
    <img src="/assets/files/pictures/picture-8.jpg" width="48" alt="picture"/>
  

</span>

      </li>
      
    

    <li>created: 2010-01-25 </li>

    <li><a href="https://github.com/CRySoL/web.source/raw/master/_posts/migrated/2010-01-25-inyeccin-de-trfico-en-chipsets-atheros.html">source / <a href="https://github.com/CRySoL/web.source/edit/master/_posts/migrated/2010-01-25-inyeccin-de-trfico-en-chipsets-atheros.html">edit</a></li>

  
    <li>categories:
    
      <a href="/categories.html#recipe-ref">recipe</a>
    
    </li>
  

  
      <li>migrated&nbsp;from&nbsp;<a href="http://crysol.org/node/1323">node/1323</a></li>
  

  
    <li>tags:
    
      <a href="/tags.html#drivers-ref">drivers</a>
    
    </li>
  
  </ul>

  
     
     
  

  
     
     
  

  <!-- AddThis Button BEGIN -->
<div class="share addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Button END -->

</div>

<div class="related">
  <h2>related</h2>
  <ul>
    
    <li><a href="/recipe/2005-09-13/ssh-y-scp-para-acceder-a-equipos-remotos-sin-escribir-la-clave-public-key-authentication">SSH y SCP para acceder a equipos remotos sin escribir la clave (public key authentication)</a></li>
    
    <li><a href="/2005-09-24/acabo-de-registrarme-en-el-portal">Acabo de registrarme en el Portal</a></li>
    
    <li><a href="/2005-09-26/buenas-a-tods">Buenas a tod@s!</a></li>
    
    <li><a href="/tale/2005-09-26/instalacin-local-de-mambo-joomla-bajo-gnu-linux">Instalación local de Mambo / Joomla bajo GNU/Linux</a></li>
    
    <li><a href="/recipe/2005-09-27/acceso-a-red-cmpus-con-firefox-y-greasemonkey">Acceso a Red C@mpus con Firefox y Greasemonkey</a></li>
    
  </ul>
</div>

<div class="recent">
  <h2>recent</h2>
  <ul>
  
    <li><a href="/recipe/2013-10-05/virtualbox-import-export-clone">VirtualBox: import/export and cloning machines</a></li>
  
    <li><a href="/recipe/2013-09-23/virtualbox-vmdk-to-vdi">Converting .vmdk virtual disk to .vdi format from command line</a></li>
  
    <li><a href="/recipe/2013-09-19/ice35-deb-packages-from-zeroc">Installing the Ice-3.5 packages from ZeroC on Debian</a></li>
  
    <li><a href="/recipe/2013-09-03/DSO">Undertanding the DSO Link Change</a></li>
  
    <li><a href="/recipe/2013-08-11/hp-p1005-debian">HP LaserJet P1005 with Debian and the free driver</a></li>
  
  </ul>
</div>

</div>

<div class="node span9">
  <div class="page-header">
    <h1>Inyección de tráfico en chipsets Atheros </h1>
  </div>

  <div class="row-fluid post-full">
    <div class="span12">
      <div class="content">
	<blockquote>Hace mucho tiempo los usuarios de madwifi contábamos con un driver maravilloso que nos permitía hacer casi cualquier cosa con nuestra tarjeta WiFi. El driver pasó al <em>mainstream</em> de Linux y de repente, en una aciaga versión 2.6.18 (o por ahí) el driver dejó de inyectar. Muchos pensábamos que sería cuestión de tiempo que reparasen este <em>bug</em>... versión tras versión no hemos podido volver a inyectar y en los foros sobre el driver nadie parece haberse dado cuenta... y eso es porque el driver <em>internamente</em> <b>nunca dejó de inyectar</b>. Esta receta explica cómo hacer que el driver funcione como antaño, cuando todos éramos felices inyectando.</blockquote>

<h2>El problema</h2>
Bueno, como decíamos en la introducción, el driver <b>nunca</b> dejó de inyectar, sin embargo, las aplicaciones que hacen uso de esta <em>feature</em> no funcionan o dicen que el <em>chipset</em> no es capaz de inyectar. ¿Cómo es esto posible?. Para responder a esta pregunta quizás primero debamos saber qué características tiene el driver y el tráfico wifi.

<h2>Estructura del driver</h2>
El driver tiene dos partes bien diferenciadas: capa <em>MAC80211</em> o interfaz con el sistema operativo y capa <em>ATH_HAL</em> o interfaz con el hardware. Ambas capas tienen colas de envío y recepción. Los <em>frames</em> o paquetes recibidos por <em>ATH_HAL</em> son procesados y pasados a las colas de la capa <em>MAC80211</em> si es necesario. Los paquetes envíados a la capa <em>MAC80211</em> son tratados y depositados en las colas de la capa <em>ATH_HAL</em> para ser envíados por el hardware.

La inyección es tratada por la capa <em>MAC80211</em>, sin embargo, <em>ATH_HAL</em> no marca ese tráfico como lo hacía antiguamente. Éste es el motivo por el que ahora <em>parece</em> que no inyectamos tráfico.

<h2>Tráfico normal vs. Tráfico inyectado</h2>
Bueno, cuando nuestro driver trabaja con tráfico normal, la cola de envío en la capa <em>MAC80211</em> no realiza un marcaje especial de los <em>frames</em>, lo que implica que todos los <em>paquetes</em> envíados esperarán su correspondiente <em>ACK</em>. La capa <em>MAC</em> puede configurar su cola de envío de forma que marque los <em>frames</em> para que no esperen respuesta. Éste método es el que se debe usar cuando la cola de envío esté en modo inyección. Y ésto es lo que actualmente se ha eliminado del driver: cuando la cola de envío está en modo inyección, los paquetes en <em>ATH_HAL</em> son tratados como tráfico corriente, cuando en realidad deberían marcarse como <em>NO_ACK</em>.

Actualmente lo que sucede es que los paquetes inyectados esperan ACK, pero jamás lo recibirán puesto que son inyectados. Por este motivo son descartados por el propio <em>ATH_HAL</em>. Para que sean procesados y enviados por <em>ATH_HAL</em> sin importar si llegan o no los <em>ACK</em> hay que marcar el tráfico como <em>NO_ACK</em>.

<h2>Dónde se marca el tráfico</h2>
Bueno, aquí depende del módulo que use nuestro <em>chipset</em>:
<ul><li><b>ath5k:</b> echamos un vistazo a <tt>base.c</tt> del código fuente:


<div>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_txbuf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">AR5K_TXDESC_INTREQ</span> <span class="o">|</span> <span class="n">AR5K_TXDESC_CLRDMASK</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_NOACK</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
</div>

La función <em>ath5k_txbuf_setup()</em> configura la cola de envío (como su propio nombre indica) y, efectivamente, vemos que si la cola se configura como <em>IEEE80211_TX_CTL_NO_ACK</em>, añade <em>AR5K_TXDESC_NOACK</em> a los <em>flags</em> de envío. Sin embargo, no hace ningún cambio si la cola está en modo <em>INJECTED</em>.</li>
<li><b>ath9k:</b> veamos el fichero <tt>xmit.c</tt> (nueva versión del ath5k con un código bastante más limpio):


<div>
<div class="highlight"><pre><code class="c"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_tx_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_CLRDMASK</span><span class="p">;</span> <span class="cm">/* needed for crypto errors */</span>
    <span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_INTREQ</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_NOACK</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

Efectivamente, la función aquí es <em>setup_tx_flags()</em>, que retorna los <em>flags</em> que usará la capa <em>ATH_HAL</em> en su cola de envío. Al igual que antes, no hace nada especial si la cola de la capa <em>MAC80211</em> se configuró como <em>INJECTED</em>.</li></ul>

<h2>Aplicar el parche (sin recompilar el Linux entero)</h2>
Ahora explicaremos como parchear el módulo en cuatro fáciles pasos, es un poco artesanal pero también más genérico (no voy a hacer parches para cada posible versión del driver :P).

<h3>Descarga del código fuente y preparación</h3>

Como ya dijeramos, los drivers <em>madwifi</em> pertenecen al <em>mainstream</em> de linux por lo que obtener los fuentes de forma separa puede no ser tan fácil como parece. En nuestro caso tenemos suerte y podemos descargar el paquete <b>compat-wireless</b> de <a href="http://linuxwireless.org/en/users/Download/stable/">Linux Wireless</a>. Nos bajamos aquel cuya versión sea la más cercana a la de nuestro núcleo, en mi caso la 2.6.32:


<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> wget http://www.orbit-lab.org/kernel/compat-wireless-2.6-stable/v2.6.32/compat-wireless-2.6.32.3.tar.bz2
<span class="gp">$</span> unp compat-wireless-2.6.32.3.tar.bz2
<span class="gp">$</span> <span class="nb">cd </span>compat-wireless-2.6.32.3
<span class="gp">$</span> sudo aptitude install module-assistant
<span class="gp">$</span> sudo m-a prepare
</code></pre></div>
</div>

Con esto habremos instalado los programas y paquetes necesarios para compilar módulos para nuestro núcleo.

<h3>Parcheado</h3>
<blockquote><b>ATENCIÓN:</b> estas modificaciones parecen ser motivos de cuelgues en núcleos con versiones 2.6.27 y similares.</blockquote>
Antes disponíamos de parches oficiales de <em>madwifi</em> pero ahora no hay (o no los encuentro) así que a manita... según el módulo que use nuestro chipset (con <em>lsmod</em> podemos ver cuál es):
<ul><li><b>ath5k</b> Modificamos la siguiente línea del fichero <tt>drivers/net/wireless/ath/ath5k/base.c</tt>:

<div>
<div class="highlight"><pre><code class="c"><span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
     <span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_NOACK</span><span class="p">;</span>
</code></pre></div>
</div>
por:

<div>
<div class="highlight"><pre><code class="c"><span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span> <span class="o">||</span>
  <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span> <span class="o">&amp;&amp;</span>
  <span class="o">!</span><span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))))</span>
     <span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_NOACK</span><span class="p">;</span>
</code></pre></div>
</div></li>
<li><b>ath9k</b> Modificamos la siguiente línea del fichero <tt>drivers/net/wireless/ath/ath9k/xmit.c</tt>:

<div>
<div class="highlight"><pre><code class="c"><span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
     <span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_NOACK</span><span class="p">;</span>
</code></pre></div>
</div>
por:

<div>
<div class="highlight"><pre><code class="c"><span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span> <span class="o">||</span>
 <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span> <span class="o">&amp;&amp;</span>
 <span class="o">!</span><span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))))</span>
     <span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_NOACK</span><span class="p">;</span>
</code></pre></div>
</div></li></ul>

Como véis, lo único que hacemos es añadir una condición más al <em>if</em> para marcar el tráfico como <em>NO_ACK</em>, y es que la cola esté configurada como <em>INJECTED</em>.

<h3>Compilación</h3>
Si todo lo anterio lo hicimos correctamente, la compilación es lo más sencillo:
<ul><li><b>ath5k</b>:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="go"> $ ./scripts/driver-select ath5k</span>
<span class="gp">$</span> make
</code></pre></div>
</div></li>
<li><b>ath9k</b>:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="go"> $ ./scripts/driver-select ath9k</span>
<span class="gp">$</span> make
</code></pre></div>
</div></li></ul>

<h3>Instalación</h3>
Bueno, el <tt>Makefile</tt> tiene el <em>target install</em> con lo que:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="go"> $ sudo make install</span>
</code></pre></div>
</div>
debería funcionar a la perfección, sin embargo, yo he hecho la instalación manual que consiste básicamente (esto es para <b>ath9k</b>, para el módulo <b>ath5k</b> se hará igual... solo cambia un fichero...):
<ol><li>Descargar los modulos ath9k, ath, mac80211 y cfg80211 de memoria:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="go"> # rmmod cfg80211 mac80211 ath ath9k</span>
</code></pre></div>
</div></li>
<li>Renombrar los ficheros:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="go"> # mv /lib/modules/$(uname -r)/kernel/net/mac80211/mac80211.ko /lib/modules/$(uname -r)/kernel/net/mac80211/mac80211.ko.disabled</span>
<span class="gp">#</span> mv /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/net/wireless/cfg80211.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/net/wireless/cfg80211.ko.disabled
<span class="gp">#</span> mv /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/net/wireless/ath/ath.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/net/wireless/ath/ath.ko.disabled
<span class="gp">#</span> mv /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/net/wireless/ath/ath9k/ath9k.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/net/wireless/ath/ath9k/ath9k.ko.disabled
</code></pre></div>
</div>
Con esto tendremos una copia de seguridad de los módulos originales.</li>
<li>Copiar ficheros creados:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> cp net/wireless/cfg80211.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/net/wireless/
<span class="gp">#</span> cp net/mac80211/mac80211.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/net/mac80211/
<span class="gp">#</span> cp drivers/net/wireless/ath/ath.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/net/wireless/ath/
<span class="gp">#</span> cp drivers/net/wireless/ath/ath9k.ko /lib/modules/<span class="k">$(</span>uname -r<span class="k">)</span>/kernel/drivers/net/wireless/ath/ath9k/
</code></pre></div>
</div>
Con esto tenemos nuestros módulos en el árbol del núcleo.</li>
<li>Actualizar dependencias:

<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> depmod -ae
</code></pre></div>
</div></li>
<li>Volvemos a cargar nuestro módulo..,

<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> modprobe ath9k
</code></pre></div>
</div></li></ol>
¡Y listo! :D

<h2>Referencias</h2>
<ul><li><a href="http://linuxwireless.org/en/users/Drivers/ath9k">http://linuxwireless.org/en/users/Drivers/ath9k</li></ul>

      </div>

      

      <hr/>

      <div class="pagination pagination-centered">
  <ul>
    
      <li class="prev"><a href="/tale/2010-01-18/cuando-lo-decamos-nos-tachaban-de-locos" title="Cuando lo decíamos nos tachaban de locos...">&larr; Previous</a></li>
    

    <li><a href="/archive.html">Archive</a></li>

    
      <li class="next"><a href="/2010-01-26/easygit-git-para-gente-normal" title="easygit: git para gente normal">Next &rarr;</a></li>
    
  </ul>
</div>


      <hr/>

      

<div id="show_comments"> [ <a onclick="show_comments();"> show comments </a> ] </div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'crysol'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
  </div>
</div>


	</div>
      </div>

      <hr/>

      <footer>
        <p>&copy; 2013 CRySoL
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
	  See <a href="https://github.com/CRySoL/CRySoL.github.io" target="_blank">site sources</a>.
	  <br/>
	  Generated at Sun Oct 06 08:47:12 +0200 2013
	</p>
      </footer>

    </div>

    
  </body>
</html>

