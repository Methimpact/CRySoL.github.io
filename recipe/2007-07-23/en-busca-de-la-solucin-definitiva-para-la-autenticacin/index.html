
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>En busca de la solución definitiva para la autenticación</title>
    
    <meta name="author" content="CRySoL">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/main.js"></script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

    

  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-narrow">
<!--
	  <a class="brand-image" href="/"><img class="brand-image" src="/assets/themes/twitter/logo.png"/></a>
-->
          <a class="brand" href="/">CRySoL</a>
          <ul class="nav">
            
            
            


  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/recipes.html">Recipes</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/users.html">Users</a></li>
      	
      
    
  
    
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="row-fluid">
	<div class="content">
          
<div class="sidebar span3">
  <div id="logo">
  <a href="/">
    <img src="/assets/images/logo.png" alt="logo"/>
  </a>
</div>

  <div class="metadata">
  <h2>this</h2>
  <ul>
    
      <li>author: 
  <a href="/users.html#paco">
   paco
  </a>


        
        <span class="author-photo">

  
    <img src="https://securecdn.disqus.com/1372120184/images/noavatar48.png" width="48" alt="no-picture"/>
  

</span>

      </li>
      
      
    

    <li>created: 2007-07-23 </li>

    <li><a href="https://github.com/CRySoL/web.source/raw/master/_posts/migrated/2007-07-23-en-busca-de-la-solucin-definitiva-para-la-autenticacin.textile">source / <a href="https://github.com/CRySoL/web.source/edit/master/_posts/migrated/2007-07-23-en-busca-de-la-solucin-definitiva-para-la-autenticacin.textile">edit</a></li>

  
    <li>categories:
    
      <a href="/categories.html#recipe-ref">recipe</a>
    
    </li>
  

  
      <li>migrated&nbsp;from&nbsp;<a href="http://crysol.org/node/743">node/743</a></li>
  

  
  </ul>

  
     
     
  

  

  <!-- AddThis Button BEGIN -->
<div class="share addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51cdd0d57c014017"></script>
<!-- AddThis Button END -->

</div>

<div class="related">
  <h2>related</h2>

  <ul>
   
   
  </ul>

  
</div>

<div class="recent">
  <h2>recent</h2>
  <ul>
  
    <li><a href="/recipe/2013-11-15/reading-a-property-file-with-augeas">Reading a properties file with augeas</a></li>
  
    <li><a href="/recipe/2013-10-28/file-grain-sudo">Fine-grain sudo</a></li>
  
    <li><a href="/recipe/2013-10-21/git-remove-from-history">git: removing files from history</a></li>
  
    <li><a href="/recipe/2013-10-15/virtualbox-compact-vmdk-images">Compacting .vmdk virtual disk with VirtualBox</a></li>
  
    <li><a href="/recipe/2013-10-12/apt-pinning">Debian apt pinning</a></li>
  
  </ul>
</div>

</div>

<div class="node span9">
  <div class="page-header">
    <h1>En busca de la solución definitiva para la autenticación </h1>
  </div>

  <div class="row-fluid post-full">
    <div class="span12">
      <div class="content">
	<blockquote class="head">
<p class="head">Los usuarios de cualquier variante de <span class="caps">GNU</span> o de Unix buscan desde siempre el Santo Grial de la administración de sistemas: autenticación flexible y centralizada, backup flexible y sencillo, homes compartidos facilitos.  En esta receta nos ocupamos del primer ingrediente, la autenticación.</p>
</blockquote>
<p><!--break--></p>
<h2>Ingredientes</h2>
<p>Todos son paquetes Debian:</p>
<ul>
	<li>libnss-ldap</li>
	<li>libnss-db</li>
	<li>nss-updatedb</li>
	<li>libpam-modules</li>
	<li>libpam-krb5</li>
	<li>libpam-ldap</li>
	<li>libpam-ccreds</li>
</ul>
<h2>Rizando el rizo de la autenticación</h2>
<p>Para el administrador existe una premisa básica: no nos gusta tener usuarios, son la fuente de todos nuestros problemas.  Pero asumiendo que un sistema sin usuarios es inviable en la mayor parte de los casos intentaremos al menos que nos den los mínimos quebraderos de cabeza.</p>
<p>La gestión de las passwords es unos de esos problemas recurrentes.  Cuando se abre una cuenta en una organización con más de un ordenador es un latazo ir entrando ordenador por ordenador para crear repetidamente el mismo usuario.  Y no es menos latazo tratar de sincronizar las passwords entre todos ellos.  Es por esto por lo que surgen los sistemas de autenticación y autorización centralizados.  Por ejemplo, cada vez es más utilizado <span class="caps">LDAP</span> y en otros ambientes más hostiles también es famosillo el Active Directory de M$.</p>
<p>Vamos a asumir un entorno realista.  Osea, tremendamente complejo, como la vida misma. Y buscaremos la solución más flexible que podamos. Por ejemplo, supongamos que nuestra empresa tiene un servidor Active Directory al que no tenemos acceso de administración. No se a vosotros pero a mi me gustaría tener la misma password del curro en mi casa.  Pero claro, no queremos que todos los empleados de nuestra empresa puedan acceder a nuestro ordenador de casa.  Y probablemente también nos gustaría gestionar nuestro propio servidor <span class="caps">LDAP</span> para poder decidir de forma centralizada quién tiene acceso a todos nuestros ordenadores. Por supuesto también hay que tener en cuenta que las redes pueden fallar.  No parece muy conveniente que necesitemos conexión permanente con el servidor <span class="caps">LDAP</span>, ni con el servidor Active Directory.</p>
<h2>Estrategia global</h2>
<p>Os propongo esta estrategia:</p>
<ul>
	<li>En primer lugar los datos de las cuentas de usuario se gestionarán de forma centralizada en un servidor <span class="caps">LDAP</span> (la configuración del servidor <span class="caps">LDAP</span> queda fuera de esta receta, ya hay muchas sobre ese tema).  Es decir, el servidor <span class="caps">LDAP</span> sustituirá siempre que se pueda a los famosos ficheros /etc/passwd, /etc/group y /etc/shadow.</li>
	<li>Sin embargo la password en principio será tomada directamente del servidor Active Directory de nuestra empresa, siempre que sea un usuario de la empresa, claro.  Si no es usuario de la empresa utilizaremos la password almacenada en el servidor <span class="caps">LDAP</span>.</li>
	<li>En todo momento mantendremos algunos usuarios locales (root y los que usa Debian) almacenando sus datos en los /etc/passwd, /etc/shadow y /etc/group normales.</li>
	<li>Mantendremos un cache de los datos remotos en el ordenador local, incluidas las passwords, para que pueda funcionar todo cuando no tengamos red.  El cache se mantiene de forma automática así que no hay nada más que hacer.  Los homes de los usuarios se crearán automáticamente la primera vez que entren.</li>
</ul>
<h2>Configuración de <span class="caps">NSS</span> (Name Service Switch)</h2>
<p>Los datos de los usuarios se obtienen mediante una función de la libc (getent) que se puede ejercitar directamente con el comando del mismo nombre.  Esta rutina se puede configurar de forma modular, para que busque los datos en nuestros célebres /etc/passwd, /etc/group, /etc/shadow, etc. o para que lo busque en otros lugares (bases de datos locales, servidores <span class="caps">LDAP</span>, servidores <span class="caps">NIS</span>, etc.).</p>
<p>Primero instalamos los paquetes necesarios:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> aptitude install libnss-ldap libnss-db nss-updatedb
</code></pre></div></div>
<p>Al instalarse libnss-ldap se pueden configurar los parámetros básicos, pero no todas las pijaditas.  Por eso es mejor editar la configuración a mano después.  Empezaremos por el archivo de configuración de <span class="caps">NSS</span> (/etc/nsswitch.conf).  En él habrá que cambiar la forma en la que se obtienen las tablas de passwd, group y shadow:</p>
<pre>
passwd:  files db [NOTFOUND=continue] ldap
group:     files db [NOTFOUND=continue] ldap
shadow:  files ldap
</pre>
<p>Esto le indica a <span class="caps">NSS</span> que primero debe mirar en los típicos archivos (/etc/passwd, /etc/group y /etc/shadow), después en el caché local y, si aún así no lo encuentra, debe buscar en el servidor <span class="caps">LDAP</span>.</p>
<p>Para que funcione la búsqueda en el servidor <span class="caps">LDAP</span> habrá que configurar el archivo /etc/libnss-ldap.conf con algo así:</p>
<pre>
uri ldaps://mi.servidor.ldap
base dc=mi,dc=organizacion
tls_cacert /etc/ldap/cacert.pem
bind_policy hard
ssl on
use_sasl off
rootuse_sasl off
idle_timelimit 3600
pam_min_uid 1000
sasl_secprops maxssf=0
nss_reconnect_tries 1
nss_reconnect_sleeptime 1
nss_reconnect_maxsleeptime 8
nss_reconnect_maxconntries 2
nss_paged_results yes
nss_base_passwd ou=People,dc=mi,dc=organizacion?one
nss_base_shadow ou=People,dc=mi,dc=organizacion?one
nss_base_group ou=Group,dc=mi,dc=organizacion?one
</pre>
<p>Donde mi.servidor.ldap es el nombre <span class="caps">DNS</span> de tu servidor ldap y dc=mi,dc=organizacion es la base de búsqueda de tu servidor <span class="caps">LDAP</span>.  Si has seguido cualquiera de las muchas recetas que hay por ahí para configurar un servidor <span class="caps">LDAP</span> sabrás de lo que hablo.</p>
<p>Asegúrate de que el archivo /etc/ldap/cacert.pem contiene el certificado de la entidad certificadora que usaste para generar el certificado de tu servidor <span class="caps">LDAP</span>.  La mayoría de las recetas proponen usar una entidad certificadora ficticia, así que este certificado lo habrás creado en el proceso de configuración del servidor <span class="caps">LDAP</span>.</p>
<p>Ahora falta rellenar el caché local con los datos del servidor <span class="caps">LDAP</span>.  Para eso usaremos:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> nss_updatedb ldap passwd
<span class="gp">#</span> nss_updatedb ldap group
</code></pre></div></div>
<p>Esto lo podemos poner en un script dentro de /etc/cron.daily/ para que se actualice automáticamente cada día con cualquier posible nuevo usuario.</p>
<p>De momento no hemos hecho nada de autenticación, solo de información de usuarios.  Y lo podemos probar:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> getent passwd
<span class="gp">#</span> getent group
<span class="gp">#</span> getent shadow
</code></pre></div></div>
<p>Nota que obtienes una salida muy parecida a lo que hay en /etc/passwd, /etc/group y /etc/shadow salvo que no hay ninguna información de passwords.</p>
<h2>Configurando <span class="caps">PAM</span> (Puggable Authentication Modules)</h2>
<p>Una vez que <span class="caps">NSS</span> funciona correctamente (¡compruébalo con getent!) podemos pasar a configurar la autenticación con <span class="caps">PAM</span>.</p>
<p>Primero instalamos los paquetitos relacionados:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">#</span> aptitude install libpam-modules libpam-krb5 libpam-ldap libpam-ccreds
</code></pre></div></div>
<p>Al instalar libpam-krb5 se configurará el servidor Kerberos5, que por si no lo habías adivinado, es el servidor Active Directory.  El default realm es el dominio de la empresa (por ejemplo, en la <span class="caps">UCLM</span> es <span class="caps">UCLM</span>.ES), el <span class="caps">KDC</span> (Kerberos Domain Controller) es el propio servidor Active Directory y el admin server es también el mismo.</p>
<p>Si quieres comprobar que funciona correctamente instala también el paquete krb5-user y prueba a autenticarte:</p>
<div class="console">
<div class="highlight"><pre><code class="console"><span class="gp">$</span> kinit -A usuario
<span class="gp">$</span> kdestroy
</code></pre></div></div>
<p>Al instalar libpam-ldap volverá a preguntar las mismas cosas que con libnss-ldap.  Nuevamente es mejor configurarlo a mano despues.  Se configura en el archivo /etc/pam_ldap.conf.  Por ejemplo:</p>
<pre>
uri ldaps://mi.servidor.ldap
base dc=mi,dc=organizacion
tls_cacert /etc/ldap/cacert.pem
bind_policy soft
timelimit 20
bind_timelimit 20
</pre>
<p>Ahora vamos a configurar <span class="caps">PAM</span>.  En primer lugar editamos el archivo /etc/pam.d/common-auth, que contiene los requisitos necesarios de autentificación, el más complejo:</p>
<pre>
auth [success=done default=ignore] pam_unix.so nullok_secure try_first_pass
auth [authinfo_unavail=ignore success=2 default=ignore] pam_krb5.so use_first_pass minimum_uid=5000
auth [authinfo_unavail=ignore success=1 default=2] pam_ldap.so use_first_pass
auth [default=done] pam_ccreds.so action=validate use_first_pass
auth [default=done] pam_ccreds.so action=store
auth [default=bad] pam_ccreds.so action=update
auth required pam_permit.so
</pre>
<p>Primero intenta autenticar con el archivo /etc/shadow normalito.  Después, si no lo consigue intenta el Active Directory.  Después si no lo consigue intenta el servidor <span class="caps">LDAP</span>. Por último intenta el caché de credenciales.  Cuando tiene éxito cualquier autenticación remota (Active Directory o <span class="caps">LDAP</span>) guarda los datos en el caché de credenciales para que en caso de desconexión de la red pueda seguir usando el equipo.</p>
<p>A continuación editamos /etc/pam.d/common-account para determinar cuándo es una cuenta válida:</p>
<pre>
account sufficient pam_unix.so nullok_secure
account sufficient pam_ldap.so
account sufficient pam_krb5.so minimum_uid=1000
account required pam_permit.so
</pre>
<p>De esta forma aún cuando el servidor <span class="caps">LDAP</span> y el Active Directory no estén accesibles al menos dirá que la cuenta es válida.</p>
<p>Cada vez que se cree una nueva sesión podemos verificar si el usuario ya tiene un directorio personal (home) y si no es así crearlo automáticamente.  Por ejemplo este podría ser el contenido de /etc/common-session:</p>
<pre>
session optional pam_krb5.so minimum_uid=5000
session required pam_unix.so
session required pam_mkhomedir.so skel=/etc/skel/ umask=0022
</pre>
<p>Se utiliza pam_krb5 para gestionar la validez de los tickets kerberos de Active Directory.  En cuanto se sale de la sesión automáticamente se destruye el ticket.  Además se utiliza pam_mkhomedir para que se creen los directorios de usuario automáticamente.</p>
<p>En cuanto a los cambios de passwords todo depende de la política que quieras seguir.  Por ejemplo:</p>
<pre>
password sufficient pam_krb5.so minimum_uid=5000
password sufficient pam_ldap.so minimum_uid=1000
password required pam_unix.so nullok obscure md5
</pre>
<h2>El caso de gnome-screensaver</h2>
<p>El gnome-screensaver es un caso bastante puñetero.  El problema es que se ejecuta como usuario normal, mientras que las credenciales cacheadas por libpam-ccreds se pueden leer/escribir solo por root.  Por tanto no podemos usar las credenciales cacheadas.</p>
<p>Una posible solución, asumiendo que hay seguridad física (que nadie no autorizado puede desenchufar de la red nuestro equipo) es cambiar el /etc/pam.d/gnome-screensaver por:</p>
<pre>
auth [success=done default=ignore] pam_unix.so nullok_secure try_first_pass
auth [authinfo_unavail=ignore success=done default=ignore] pam_krb5.so use_first_pass minimum_uid=5000
auth [authinfo_unavail=ignore success=done default=bad] pam_ldap.so use_first_pass
auth required pam_permit.so
</pre>
<p>Pero cuidado con esto, porque en caso de desconexión de la red cualquier password bastará para desbloquear el escritorio.  A mi me parece aceptable, porque mi compañero de despacho es de fiar, pero vosotros vereis&#8230;</p>
<p>Otra posibilidad es requerir que para desbloquear el escritorio haya conexión de red.  Por ejemplo, con este /etc/pam.d/gnome-screensaver:</p>
<pre>
auth [success=done default=ignore] pam_unix.so nullok_secure try_first_pass
auth [authinfo_unavail=ignore success=done default=ignore] pam_krb5.so use_first_pass minimum_uid=5000
auth required pam_ldap.so use_first_pass
</pre>
<h2>Resumen</h2>
<p>¿Qué hemos conseguido?</p>
<ul>
	<li>Los usuarios de nuestros equipos pueden ser gestionados de forma centralizada en un servidor <span class="caps">LDAP</span>.</li>
	<li>Las passwords que no tengamos que guardar nosotros no las guardamos, las delegamos en el Active Directory de nuestra empresa.</li>
	<li>Diariamente se sincroniza el servidor <span class="caps">LDAP</span> con la base de datos local de cada equipo con datos de identificación.</li>
	<li>La primera vez que entran en un equipo crean su directorio personal y cachean sus datos de autenticación.</li>
	<li>En caso de desconexión de la red todo funciona con los datos cacheados.</li>
</ul>
<h2>Referencias</h2>
<ul>
	<li><a href="http://crysol.org/node/370">Experimentando con Active Directory y OpenLDAP | CRySoL</a></li>
	<li><a href="https://help.ubuntu.com/community/PamCcredsHowto">Instructions to install &amp; configure libpam-ccreds on Ubuntu 5.10</a>.</li>
	<li><a href="https://help.ubuntu.com/community/LDAPClientAuthentication"><span class="caps">LDAP</span> Client Authentication on Ubuntu</a>.</li>
	<li><a href="https://help.ubuntu.com/community/ActiveDirectoryHowto">Active Directory Authentication on Ubuntu</a>.</li>
</ul>
      </div>

      

      <hr/>

      <div class="pagination pagination-centered">
  <ul>
    
      <li class="prev"><a href="/new/2007-07-21/software-para-electrnicos-kicad" title="Software para electrónicos: kicad">&larr; Previous</a></li>
    

    <li><a href="/archive.html">Archive</a></li>

    
      <li class="next"><a href="/opinion/2007-07-24/linus-tolvards-eres-mu-tonto-tontismo" title="Linus Tolvards: eres "mu" tonto (tontismo).">Next &rarr;</a></li>
    
  </ul>
</div>


      <hr/>

      

<div id="show_comments"> [ <a onclick="show_comments();"> show comments </a> ] </div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'crysol'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






    </div>
  </div>
</div>


	</div>
      </div>

      <hr/>

      <footer>
        <p>&copy; 2013 CRySoL
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>.
	  See <a href="https://github.com/CRySoL/web.source" target="_blank">site sources</a>.
	  <br/>
	  Generated at Tue Nov 19 00:01:55 +0100 2013
	</p>
      </footer>

    </div>

    
  </body>
</html>

